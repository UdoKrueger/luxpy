<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>luxpy.toolboxes.spdbuild.spdoptimizer2020 &mdash; LuxPy 1.9.6 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> LuxPy
          </a>
              <div class="version">
                1.9.6
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../license.html">License: GPLv3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../required_packages.html">Imported (required) packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../luxpy_structure.html">Luxpy package structure</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">LuxPy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      <li>luxpy.toolboxes.spdbuild.spdoptimizer2020</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for luxpy.toolboxes.spdbuild.spdoptimizer2020</h1><div class="highlight"><pre>
<span></span><span class="c1"># # -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module for building and optimizing SPDs (2)</span>
<span class="sd">===========================================</span>

<span class="sd">This module implements a class based spectral optimizer. It differs from </span>
<span class="sd">the spdoptimizer function in spdbuild.py, in that it can use several </span>
<span class="sd">different minimization algorithms, as well as a user defined method. </span>
<span class="sd">It is also written such that the user can easily write his own</span>
<span class="sd">primary constructor function. It supports the &#39;3mixer&#39; algorithm </span>
<span class="sd">(but no &#39;2mixer&#39;) and a &#39;no-mixer&#39; algorithm (chromaticity as part of the list</span>
<span class="sd">of objectives) for calculating the mixing contributions of the primaries.</span>

<span class="sd">Functions</span>
<span class="sd">---------</span>
<span class="sd"> :gaussian_prim_constructor(): constructs a gaussian based primary set.</span>
<span class="sd"> </span>
<span class="sd"> :_setup_wlr(): Initialize the wavelength range for use with PrimConstructor.</span>
<span class="sd"> </span>
<span class="sd"> :_extract_prim_optimization_parameters(): Extract the primary parameters from the optimization vector x and the pdefs dict for use with PrimConstructor.</span>

<span class="sd"> :_stack_wlr_spd():  Stack the wavelength range &#39;on top&#39; of the spd values for use with PrimConstructor.</span>
<span class="sd"> </span>
<span class="sd"> :PrimConstructor: class for primary (spectral) construction</span>
<span class="sd">     </span>
<span class="sd"> :Minimizer: class for minimization of fitness of each of the objective functions</span>
<span class="sd"> </span>
<span class="sd"> :ObjFcns: class to specify one or more objective functions for minimization</span>
<span class="sd"> </span>
<span class="sd"> :SpectralOptimizer: class for spectral optimization (initialization and run)</span>
<span class="sd"> </span>
<span class="sd"> :spd_optimizer2(): Generate a spectrum with specified white point and optimized</span>
<span class="sd">                   for certain objective functions from a set of component </span>
<span class="sd">                   spectra or component spectrum model parameters </span>
<span class="sd">                   (functional wrapper around SpectralOptimizer class).</span>

<span class="sd">                </span>
<span class="sd">Notes</span>
<span class="sd">-----</span>
<span class="sd"> 1. See examples below (in &#39;__main__&#39;) for use.</span>
<span class="sd"> </span>
<span class="sd"> 2. Minimizer built-in options &#39;particleswarm&#39; and &#39;nsga_ii&#39; require</span>
<span class="sd"> pyswarms and pymoo packages to be installed. To minimize the dependency list </span>
<span class="sd"> of luxpy on &#39;specialized&#39; packages, these are not automatically installed</span>
<span class="sd"> along with luxpy. However, an attempt will be made to pip install them</span>
<span class="sd"> on first import (so please be patient when running these options for the first</span>
<span class="sd"> time). If the pip install fails, try a manual install using either pip or conda.</span>
<span class="sd"> </span>


<span class="sd">.. codeauthor:: Kevin A.G. Smet (ksmet1977 at gmail.com)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">luxpy</span> <span class="kn">import</span> <span class="p">(</span><span class="n">math</span><span class="p">,</span> <span class="n">_WL3</span><span class="p">,</span> <span class="n">_CIEOBS</span><span class="p">,</span> <span class="n">getwlr</span><span class="p">,</span> <span class="n">SPD</span><span class="p">,</span> <span class="n">spd_to_xyz</span><span class="p">,</span> 
                    <span class="n">xyz_to_Yxy</span><span class="p">,</span> <span class="n">colortf</span><span class="p">,</span> <span class="n">xyz_to_cct</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">luxpy.utils</span> <span class="kn">import</span> <span class="n">sp</span><span class="p">,</span><span class="n">np</span><span class="p">,</span> <span class="n">plt</span><span class="p">,</span> <span class="n">_EPS</span><span class="p">,</span> <span class="n">np2d</span>
<span class="kn">from</span> <span class="nn">luxpy</span> <span class="kn">import</span> <span class="n">cri</span> 



<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PrimConstructor&#39;</span><span class="p">,</span><span class="s1">&#39;Minimizer&#39;</span><span class="p">,</span><span class="s1">&#39;ObjFcns&#39;</span><span class="p">,</span><span class="s1">&#39;SpectralOptimizer&#39;</span><span class="p">,</span>
           <span class="s1">&#39;_extract_prim_optimization_parameters&#39;</span><span class="p">,</span> <span class="s1">&#39;_stack_wlr_spd&#39;</span><span class="p">,</span><span class="s1">&#39;_setup_wlr&#39;</span><span class="p">,</span>
           <span class="s1">&#39;spd_optimizer2&#39;</span><span class="p">,</span> <span class="s1">&#39;gaussian_prim_constructor&#39;</span><span class="p">,</span> <span class="s1">&#39;gaussian_prim_parameter_types&#39;</span><span class="p">,</span>
           <span class="s1">&#39;_triangle_mixer&#39;</span><span class="p">,</span> <span class="s1">&#39;_color3mixer&#39;</span><span class="p">]</span>

<span class="c1">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="_color3mixer"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild._color3mixer">[docs]</a><span class="k">def</span> <span class="nf">_color3mixer</span><span class="p">(</span><span class="n">Yxyt</span><span class="p">,</span><span class="n">Yxy1</span><span class="p">,</span><span class="n">Yxy2</span><span class="p">,</span><span class="n">Yxy3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate fluxes required to obtain a target chromaticity </span>
<span class="sd">    when (additively) mixing 3 light sources.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :Yxyt: </span>
<span class="sd">            | ndarray with target Yxy chromaticities.</span>
<span class="sd">        :Yxy1: </span>
<span class="sd">            | ndarray with Yxy chromaticities of light sources 1.</span>
<span class="sd">        :Yxy2:</span>
<span class="sd">            | ndarray with Yxy chromaticities of light sources 2.</span>
<span class="sd">        :Yxy3:</span>
<span class="sd">            | ndarray with Yxy chromaticities of light sources 3.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        :M: </span>
<span class="sd">            | ndarray with fluxes.</span>
<span class="sd">        </span>
<span class="sd">    Note:</span>
<span class="sd">        Yxyt, Yxy1, ... can contain multiple rows, referring to single mixture.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Y1</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">Yxy1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Yxy1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">Yxy1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">Y2</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">Yxy2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Yxy2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">Yxy2</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">Y3</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">y3</span> <span class="o">=</span> <span class="n">Yxy3</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Yxy3</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">Yxy3</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">Yt</span><span class="p">,</span> <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="n">Yxyt</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Yxyt</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">Yxyt</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="n">y1</span><span class="o">*</span><span class="p">((</span><span class="n">xt</span><span class="o">-</span><span class="n">x3</span><span class="p">)</span><span class="o">*</span><span class="n">y2</span><span class="o">-</span><span class="p">(</span><span class="n">yt</span><span class="o">-</span><span class="n">y3</span><span class="p">)</span><span class="o">*</span><span class="n">x2</span><span class="o">+</span><span class="n">x3</span><span class="o">*</span><span class="n">yt</span><span class="o">-</span><span class="n">xt</span><span class="o">*</span><span class="n">y3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">yt</span><span class="o">*</span><span class="p">((</span><span class="n">x3</span><span class="o">-</span><span class="n">x2</span><span class="p">)</span><span class="o">*</span><span class="n">y1</span><span class="o">+</span><span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="n">y3</span><span class="o">+</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">x3</span><span class="p">)</span><span class="o">*</span><span class="n">y2</span><span class="p">))</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="o">-</span><span class="n">y2</span><span class="o">*</span><span class="p">((</span><span class="n">xt</span><span class="o">-</span><span class="n">x3</span><span class="p">)</span><span class="o">*</span><span class="n">y1</span><span class="o">-</span><span class="p">(</span><span class="n">yt</span><span class="o">-</span><span class="n">y3</span><span class="p">)</span><span class="o">*</span><span class="n">x1</span><span class="o">+</span><span class="n">x3</span><span class="o">*</span><span class="n">yt</span><span class="o">-</span><span class="n">xt</span><span class="o">*</span><span class="n">y3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">yt</span><span class="o">*</span><span class="p">((</span><span class="n">x3</span><span class="o">-</span><span class="n">x2</span><span class="p">)</span><span class="o">*</span><span class="n">y1</span><span class="o">+</span><span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="n">y3</span><span class="o">+</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">x3</span><span class="p">)</span><span class="o">*</span><span class="n">y2</span><span class="p">))</span>
    <span class="n">m3</span> <span class="o">=</span> <span class="n">y3</span><span class="o">*</span><span class="p">((</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="n">yt</span><span class="o">-</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span><span class="o">*</span><span class="n">xt</span><span class="o">+</span><span class="n">x1</span><span class="o">*</span><span class="n">y2</span><span class="o">-</span><span class="n">x2</span><span class="o">*</span><span class="n">y1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">yt</span><span class="o">*</span><span class="p">((</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span><span class="o">*</span><span class="n">y3</span><span class="o">-</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span><span class="o">*</span><span class="n">x3</span><span class="o">+</span><span class="n">x1</span><span class="o">*</span><span class="n">y2</span><span class="o">-</span><span class="n">x2</span><span class="o">*</span><span class="n">y1</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">Yxy1</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">Yt</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">m1</span><span class="o">/</span><span class="n">Y1</span><span class="p">,</span><span class="n">m2</span><span class="o">/</span><span class="n">Y2</span><span class="p">,</span><span class="n">m3</span><span class="o">/</span><span class="n">Y3</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">Yt</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">m1</span><span class="o">/</span><span class="n">Y1</span><span class="p">,</span><span class="n">m2</span><span class="o">/</span><span class="n">Y2</span><span class="p">,</span><span class="n">m3</span><span class="o">/</span><span class="n">Y3</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">M</span></div>

<div class="viewcode-block" id="_triangle_mixer"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild._triangle_mixer">[docs]</a><span class="k">def</span> <span class="nf">_triangle_mixer</span><span class="p">(</span><span class="n">Yxy_target</span><span class="p">,</span> <span class="n">Yxyi</span><span class="p">,</span> <span class="n">triangle_strengths</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the fluxes of each of the primaries to realize the target chromaticity Yxy_target given the triangle_strengths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">triangle_strengths</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">Yxyi</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Generate all possible 3-channel combinations (component triangles):</span>
    <span class="n">combos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="mi">3</span><span class="p">)))</span> 
    <span class="n">Nc</span> <span class="o">=</span> <span class="n">combos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># calculate fluxes to obtain target Yxyt:</span>
    <span class="n">M3</span> <span class="o">=</span> <span class="n">_color3mixer</span><span class="p">(</span><span class="n">Yxy_target</span><span class="p">,</span><span class="n">Yxyi</span><span class="p">[:,</span><span class="n">combos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],:],</span><span class="n">Yxyi</span><span class="p">[:,</span><span class="n">combos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],:],</span><span class="n">Yxyi</span><span class="p">[:,</span><span class="n">combos</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],:])</span>
    
    <span class="c1"># Get rid of out-of-gamut solutions:</span>
    <span class="n">is_out_of_gamut</span> <span class="o">=</span>  <span class="p">(((</span><span class="n">M3</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">n_in_gamut</span> <span class="o">=</span> <span class="n">Nc</span> <span class="o">-</span> <span class="n">is_out_of_gamut</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">n_in_gamut</span><span class="p">[</span><span class="n">n_in_gamut</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># avoid div by zero</span>

    <span class="n">M3</span><span class="p">[</span><span class="n">is_out_of_gamut</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">triangle_strengths</span><span class="p">[</span><span class="n">is_out_of_gamut</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">if</span> <span class="n">Nc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>
        
        <span class="c1"># Calulate fluxes of all components from M3 and x_final:</span>
        <span class="n">triangle_strengths</span> <span class="o">=</span> <span class="n">triangle_strengths</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">triangle_strengths</span><span class="p">,</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># normalize to sum to 1</span>
        <span class="n">M_final</span> <span class="o">=</span> <span class="n">triangle_strengths</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">M3</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">M_final</span><span class="o">*</span><span class="p">(</span><span class="n">combos</span> <span class="o">==</span> <span class="n">i</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span><span class="o">...</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="c1">#/n_in_gamut</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">M3</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:]</span>
    <span class="n">M</span><span class="p">[</span><span class="n">M</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">M</span></div>

<span class="c1">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="_stack_wlr_spd"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild._stack_wlr_spd">[docs]</a><span class="k">def</span> <span class="nf">_stack_wlr_spd</span><span class="p">(</span><span class="n">wlr</span><span class="p">,</span><span class="n">spd</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stack the wavelength range on top of the spd values for use with PrimConstructor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">wlr</span><span class="p">,</span><span class="n">spd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">spd</span><span class="p">)),</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">spd</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">spd</span></div>

<div class="viewcode-block" id="_setup_wlr"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild._setup_wlr">[docs]</a><span class="k">def</span> <span class="nf">_setup_wlr</span><span class="p">(</span><span class="n">wlr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setup the wavelength range for use with PrimConstructor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wlr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">wlr</span> <span class="o">=</span> <span class="n">getwlr</span><span class="p">(</span><span class="n">wlr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">wlr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">wlr</span> <span class="o">=</span> <span class="n">wlr</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,:]</span>
    <span class="k">elif</span> <span class="n">wlr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">wlr</span> <span class="o">=</span> <span class="n">wlr</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span>
    <span class="k">return</span> <span class="n">wlr</span><span class="o">.</span><span class="n">T</span></div>

<div class="viewcode-block" id="_extract_prim_optimization_parameters"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild._extract_prim_optimization_parameters">[docs]</a><span class="k">def</span> <span class="nf">_extract_prim_optimization_parameters</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nprims</span><span class="p">,</span> 
                                          <span class="n">prim_constructor_parameter_types</span><span class="p">,</span> 
                                          <span class="n">prim_constructor_parameter_defs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the primary parameters from the optimization vector x and the prim_constructor_parameter_defs dict, for use with PrimConstructor..</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">types</span> <span class="o">=</span> <span class="n">prim_constructor_parameter_types</span>
    <span class="n">pars</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prim_constructor_parameter_defs</span><span class="p">:</span> <span class="c1"># extract value from x (to be optimized as not in _defs dict!)</span>
            <span class="n">pars</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">[:,(</span><span class="n">ct</span><span class="o">*</span><span class="n">nprims</span><span class="p">):(</span><span class="n">ct</span><span class="o">*</span><span class="n">nprims</span><span class="p">)</span> <span class="o">+</span> <span class="n">nprims</span><span class="p">])</span>
            <span class="n">ct</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pars</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prim_constructor_parameter_defs</span><span class="p">[</span><span class="n">pt</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">pars</span></div>
         
            
<span class="k">def</span> <span class="nf">_get_default_prim_parameters</span><span class="p">(</span><span class="n">nprims</span><span class="p">,</span> <span class="n">parameter_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;peakwl&#39;</span><span class="p">,</span> <span class="s1">&#39;fwhm&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get dict with default primary parameters, dict with parameter bounds and a list with parameters to be optimized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">parameter_to_be_optimized</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">parameter_defaults</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">parameter_bnds</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">parameter_types</span><span class="p">:</span>
        <span class="c1"># set up default parameter values (when not optimized):</span>
        <span class="k">if</span> <span class="n">pt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">parameter_to_be_optimized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pdefs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">pdefs</span><span class="p">,</span><span class="nb">int</span><span class="p">)</span> <span class="o">|</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdefs</span><span class="p">,</span><span class="nb">float</span><span class="p">)):</span> <span class="n">pdefs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pdefs</span><span class="p">]</span><span class="o">*</span><span class="n">nprims</span>
            <span class="n">parameter_defaults</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdefs</span>
        <span class="c1"># Create bnds for parameters to be optimized:</span>
        <span class="k">if</span> <span class="n">pt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pt</span><span class="o">+</span><span class="s1">&#39;_bnds&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">parameter_bnds</span><span class="p">[</span><span class="n">pt</span><span class="o">+</span><span class="s1">&#39;_bnds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parameter_bnds</span><span class="p">[</span><span class="n">pt</span><span class="o">+</span><span class="s1">&#39;_bnds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pt</span><span class="o">+</span><span class="s1">&#39;_bnds&#39;</span><span class="p">)</span>
            <span class="n">parameter_bnds</span><span class="p">[</span><span class="n">pt</span><span class="o">+</span><span class="s1">&#39;_bnds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_parse_bnds</span><span class="p">(</span><span class="n">parameter_bnds</span><span class="p">[</span><span class="n">pt</span><span class="o">+</span><span class="s1">&#39;_bnds&#39;</span><span class="p">],</span> <span class="n">nprims</span><span class="p">)</span> <span class="c1"># parse temporary bnds to final ones</span>
    <span class="n">parameter_defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1"># add remaining parameters to dict with defaults for unpacking in prim_constructor function</span>
    <span class="k">return</span> <span class="n">parameter_defaults</span><span class="p">,</span> <span class="n">parameter_bnds</span><span class="p">,</span> <span class="n">parameter_to_be_optimized</span>


<span class="k">def</span> <span class="nf">_parse_bnds</span><span class="p">(</span><span class="n">bnds</span><span class="p">,</span><span class="n">n</span><span class="p">,</span> <span class="n">min_</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e100</span><span class="p">,</span> <span class="n">max_</span> <span class="o">=</span> <span class="mf">1e100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Setup the lower- and upper-bounds for n primary mixtures.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">bnds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">min_</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
        <span class="n">ub</span> <span class="o">=</span> <span class="n">max_</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="n">min_</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="n">max_</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
        
        <span class="n">lb</span> <span class="o">=</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">))</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">int</span><span class="p">)</span> <span class="o">|</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ub</span> <span class="o">=</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">))</span> <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">int</span><span class="p">)</span> <span class="o">|</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">lb</span><span class="p">,</span><span class="n">ub</span><span class="p">))</span>


<span class="c1">#------------------------------------------------------------------------------</span>
<span class="c1"># Example code for a primiary constructor function:</span>
<span class="n">gaussian_prim_parameter_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;peakwl&#39;</span><span class="p">,</span> <span class="s1">&#39;fwhm&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="gaussian_prim_constructor"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.gaussian_prim_constructor">[docs]</a><span class="k">def</span> <span class="nf">gaussian_prim_constructor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nprims</span><span class="p">,</span> <span class="n">wlr</span><span class="p">,</span> <span class="n">ptypes</span><span class="p">,</span> <span class="o">**</span><span class="n">pdefs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a set of nprim gaussian primaries with wavelengths wlr using the input in x and in kwargs.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :x:</span>
<span class="sd">            | ndarray (M x nprim) with optimization parameters.</span>
<span class="sd">        :nprim:</span>
<span class="sd">            | number of primaries</span>
<span class="sd">        :wlr:</span>
<span class="sd">            | wavelength range for which to construct a spectrum</span>
<span class="sd">        :prim_constructor:</span>
<span class="sd">            | function that constructs the primaries from the optimization parameters</span>
<span class="sd">            | Should have the form: </span>
<span class="sd">            |   prim_constructor(x, n, wl, ptypes, pdefs)</span>
<span class="sd">        :ptypes:</span>
<span class="sd">            | gaussian_prim_parameter_types [&#39;peakwl&#39;, &#39;fwhm&#39;], optional</span>
<span class="sd">            | List with strings of the parameters used by PrimConstructor()) to</span>
<span class="sd">            | calculate the primary spd. All parameters listed and that do not</span>
<span class="sd">            | have default values (one for each prim!!!) in pdefs will be optimized.</span>
<span class="sd">        :pdefs:</span>
<span class="sd">            | Dict with constructor parameters required by PrimConstructor and/or </span>
<span class="sd">            | default values for parameters that are not being optimized.</span>
<span class="sd">            | For example: {&#39;fwhm&#39;:  [30]} will keep fwhm fixed and not optimize it.</span>
<span class="sd">            </span>
<span class="sd">    Returns:</span>
<span class="sd">        :spd:</span>
<span class="sd">            | ndarray with spectrum of nprim primaries (1st row = wavelengths)</span>
<span class="sd">            </span>
<span class="sd">            </span>
<span class="sd">    Example on how to create constructor:</span>
<span class="sd">        | ```def gaussian_prim_constructor(x, nprims, wlr, ptypes, **pdefs):```</span>
<span class="sd">        | ``` ```</span>
<span class="sd">        | ```    # Extract the primary parameters from x and pdefs:```</span>
<span class="sd">        | ```    pars = _extract_prim_optimization_parameters(x, nprims, ptypes, pdefs)```</span>
<span class="sd">        | ``` ```</span>
<span class="sd">        | ```    # Setup wavelengths:```</span>
<span class="sd">        | ```    wlr = _setup_wlr(wlr)```</span>
<span class="sd">        | ``` ```</span>
<span class="sd">        | ```    # Conversion factor for FWHM to sigma of Gaussian:```</span>
<span class="sd">        | ```    fwhm_to_sig = 1/(2*(2*np.log(2))**0.5) ```</span>
<span class="sd">        | ``` ```</span>
<span class="sd">        | ```    # Create spectral profile function: ```</span>
<span class="sd">        | ```    spd = np.exp(-0.5*((pars[&#39;peakwl&#39;]-wlr)/(pars[&#39;fwhm&#39;]*fwhm_to_sig))**2)```</span>
<span class="sd">        | ``` ```</span>
<span class="sd">        | ```    # Stack wlr and spd together: ```</span>
<span class="sd">        | ```    return _stack_wlr_spd(wlr,spd)``` </span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Extract the primary parameters from x and prim_constructor_parameter_defs:</span>
    <span class="n">pars</span> <span class="o">=</span> <span class="n">_extract_prim_optimization_parameters</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nprims</span><span class="p">,</span> <span class="n">ptypes</span><span class="p">,</span> <span class="n">pdefs</span><span class="p">)</span>
    
    <span class="c1"># setup wavelengths:</span>
    <span class="n">wlr</span> <span class="o">=</span> <span class="n">_setup_wlr</span><span class="p">(</span><span class="n">wlr</span><span class="p">)</span>
    
    <span class="c1"># Collect parameters from pars dict:</span>
    <span class="n">fwhm_to_sig</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span> <span class="c1"># conversion factor for FWHM to sigma of Gaussian</span>
    <span class="k">return</span> <span class="n">_stack_wlr_spd</span><span class="p">(</span><span class="n">wlr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;peakwl&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">wlr</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">fwhm_to_sig</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>  </div>


<div class="viewcode-block" id="PrimConstructor"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.PrimConstructor">[docs]</a><span class="k">class</span> <span class="nc">PrimConstructor</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span> <span class="o">=</span> <span class="n">gaussian_prim_constructor</span><span class="p">,</span>
                  <span class="n">ptypes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;peakwl&#39;</span><span class="p">,</span> <span class="s1">&#39;fwhm&#39;</span><span class="p">],</span> 
                  <span class="n">pdefs</span> <span class="o">=</span> <span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup instance with a constructor function f for the primaries in the light mixture.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            :f: </span>
<span class="sd">                | gaussian_prim_constructor, optional</span>
<span class="sd">                | Constructor function handle.</span>
<span class="sd">                | see below for example on definition.</span>
<span class="sd">            :ptypes:</span>
<span class="sd">                | [&#39;peakwl&#39;, &#39;fwhm&#39;], optional</span>
<span class="sd">                | List of variables names in the constructor function.</span>
<span class="sd">            :pdefs:</span>
<span class="sd">                | {}, optional</span>
<span class="sd">                | Dictionary with default values for the constructor variables.</span>
<span class="sd">                | If a variable is in this dictionary it will not be optimized.</span>
<span class="sd">                | variable optimization bounds can also be specified as name+&#39;_bnds&#39;, </span>
<span class="sd">                | eg. {&#39;peakwl_bnds&#39;:[400,700]} sets 400 and 700 as the lower and</span>
<span class="sd">                | upper bounds of the &#39;peakwl&#39; variable.</span>
<span class="sd">            </span>
<span class="sd">        </span>
<span class="sd">            Example on how to create constructor:</span>
<span class="sd">                | ```def gaussian_prim_constructor(x, nprims, wlr, ptypes, **pdefs):```</span>
<span class="sd">                | ``` ```</span>
<span class="sd">                | ```    # Extract the primary parameters from x and pdefs:```</span>
<span class="sd">                | ```    pars = _extract_prim_optimization_parameters(x, nprims, ptypes, pdefs)```</span>
<span class="sd">                | ``` ```</span>
<span class="sd">                | ```    # Setup wavelengths:```</span>
<span class="sd">                | ```    wlr = _setup_wlr(wlr)```</span>
<span class="sd">                | ``` ```</span>
<span class="sd">                | ```    # Conversion factor for FWHM to sigma of Gaussian:```</span>
<span class="sd">                | ```    fwhm_to_sig = 1/(2*(2*np.log(2))**0.5) ```</span>
<span class="sd">                | ``` ```</span>
<span class="sd">                | ```    # Create spectral profile function: ```</span>
<span class="sd">                | ```    spd = np.exp(-0.5*((pars[&#39;peakwl&#39;]-wlr)/(pars[&#39;fwhm&#39;]*fwhm_to_sig))**2)```</span>
<span class="sd">                | ``` ```</span>
<span class="sd">                | ```    # Stack wlr and spd together: ```</span>
<span class="sd">                | ```    return _stack_wlr_spd(wlr,spd)``` </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ptypes</span> <span class="o">=</span> <span class="n">ptypes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdefs</span> <span class="o">=</span> <span class="n">pdefs</span> 
    
<div class="viewcode-block" id="PrimConstructor.get_spd"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.PrimConstructor.get_spd">[docs]</a>    <span class="k">def</span> <span class="nf">get_spd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nprim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">wlr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">360</span><span class="p">,</span><span class="mi">830</span><span class="p">,</span><span class="mi">1</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get ndarray with spds for prims.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            :nprim:</span>
<span class="sd">                | None, optional</span>
<span class="sd">                | If not None: generate nprim random prims (based fixed pars and bounds in pdefs) </span>
<span class="sd">                | else: values for all pars should be defined in pdefs! </span>
<span class="sd">                |       (nprims is determined by number of elements in pdefs[ptypes[0]])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pdefs_present</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ptypes</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdefs</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pdefs_present</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ptypes</span><span class="p">)):</span> <span class="c1"># everything needed is already in pdefs!!!</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">([],</span><span class="n">nprim</span><span class="p">,</span><span class="n">wlr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ptypes</span><span class="p">,</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">pdefs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">nprim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pdefs_present</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pdefs_present</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span> <span class="n">nprim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdefs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ptypes</span><span class="p">[</span><span class="n">pdefs_present</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])</span>
            <span class="c1"># random x only for free bnds:</span>
            <span class="n">fixed_pars_defs</span><span class="p">,</span><span class="n">free_pars_bnds</span><span class="p">,</span><span class="n">free_pars</span> <span class="o">=</span> <span class="n">_get_default_prim_parameters</span><span class="p">(</span><span class="n">nprim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptypes</span><span class="p">,</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">pdefs</span><span class="p">)</span> 
            <span class="n">bnds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">free_pars_bnds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> 
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># in case of self.prim not None!!</span>
                    <span class="n">bnds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">bnds</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
            <span class="n">bnds</span> <span class="o">=</span> <span class="n">bnds</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">bnds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">],</span> <span class="n">bnds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bnds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span><span class="o">.</span><span class="n">T</span> <span class="c1"># generate random start value within bounds</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">nprim</span><span class="p">,</span><span class="n">wlr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ptypes</span><span class="p">,</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">pdefs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;nprim = None in prim_constructor.&#39;</span><span class="p">)</span></div></div>
        
        
       
<div class="viewcode-block" id="ObjFcns"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.ObjFcns">[docs]</a><span class="k">class</span> <span class="nc">ObjFcns</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fp</span> <span class="o">=</span> <span class="p">[{}],</span> <span class="n">fw</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ft</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ft_tol</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">f_requires_solution_info</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">],</span> <span class="n">decimals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup instance with objective functions, their input parameters, their respective weights and target values.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            :f: </span>
<span class="sd">                | None or list, optional</span>
<span class="sd">                | Function handles to objective function.</span>
<span class="sd">            :fp:</span>
<span class="sd">                | [{}] or list, optional</span>
<span class="sd">                | Parameter dicts for each obj. fcn.</span>
<span class="sd">            :fw:</span>
<span class="sd">                | [1] or list, optional.</span>
<span class="sd">                | Weigths for each obj. fcn</span>
<span class="sd">            :ft:</span>
<span class="sd">                | [0] or list, optional</span>
<span class="sd">                | Target values for each objective function.</span>
<span class="sd">            :ft_tol:</span>
<span class="sd">                | [0] or list, optional</span>
<span class="sd">                | Tolerance on target value.</span>
<span class="sd">                | If abs(f_j(x)-ft_j) &lt; ft_tol_j:</span>
<span class="sd">                |    then objective value F_j (see notes below) </span>
<span class="sd">                |    will be set to zero.</span>
<span class="sd">            :f_requires_solution_info:</span>
<span class="sd">                | [False] or list, optional</span>
<span class="sd">                | Set to True if the user-defined objective function requires</span>
<span class="sd">                | more info on the solution. </span>
<span class="sd">                | If True the objective function should contain a keyword argument &#39;solution_info&#39;.</span>
<span class="sd">                | In solution_info dict the user will find the following keys:</span>
<span class="sd">                |   - &#39;xs&#39; : the current optimization values x for the spds being evaluated.</span>
<span class="sd">                |   - &#39;primss&#39; : the primary spds corresponding to the current optimization values x.</span>
<span class="sd">                |   - &#39;Ms&#39; : the channel fluxes corresponding to the current optimization values x.</span>
<span class="sd">                |   - &#39;Yxys&#39; : the Yxy chromaticity coordinates corresponding to the current optimization values x.</span>
<span class="sd">            :decimals:</span>
<span class="sd">                | [5], optional</span>
<span class="sd">                | Rounding decimals of objective function values.</span>
<span class="sd">                </span>
<span class="sd">        Notes:</span>
<span class="sd">            1. The objective value F_j for each objective function f_j is calculated as: </span>
<span class="sd">            |      F_j = (fw_j*abs((f_j(x)-ft_j)/ft_j)) </span>
<span class="sd">            2. If ft_j==0 then ft_j in the denominator is set to 1 to avoid division by zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equalize_sizes</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equalize_sizes</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equalize_sizes</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ft_tol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equalize_sizes</span><span class="p">(</span><span class="n">ft_tol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decimals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equalize_sizes</span><span class="p">(</span><span class="n">decimals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_requires_solution_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_equalize_sizes</span><span class="p">(</span><span class="n">f_requires_solution_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_normalization_factors</span><span class="p">()</span>
        
        <span class="c1"># get number of objectives:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nobjs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="nb">tuple</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nobjs</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nobjs</span> <span class="o">+=</span> <span class="mi">1</span>
                
    
<div class="viewcode-block" id="ObjFcns._equalize_sizes"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.ObjFcns._equalize_sizes">[docs]</a>    <span class="k">def</span> <span class="nf">_equalize_sizes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>    
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Equalize structure of x to that of self.f for ease of looping of the objective functions in the fitness function</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span> 
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">tuple</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">dict</span><span class="p">)):</span>
                    <span class="n">xi</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">return</span> <span class="n">xs</span></div>
        
<div class="viewcode-block" id="ObjFcns._calculate_fj"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.ObjFcns._calculate_fj">[docs]</a>    <span class="k">def</span> <span class="nf">_calculate_fj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spdi</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">solution_info</span> <span class="o">=</span> <span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate objective function j for input spd.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate objective function j:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_requires_solution_info</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span> 
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="nb">tuple</span><span class="p">):</span> <span class="c1"># one function for each objective:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">](</span><span class="n">spdi</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># one function for multiple objectives for increased speed:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">](</span><span class="n">spdi</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">idx</span> <span class="o">=</span> <span class="n">solution_info</span><span class="p">[</span><span class="s1">&#39;notnan_spds&#39;</span><span class="p">]</span> <span class="c1"># to index notnan_spds</span>
            <span class="c1"># print(idx.shape,solution_info[&#39;xs&#39;].shape,solution_info[&#39;Ms&#39;].shape,solution_info[&#39;primss&#39;].shape, solution_info[&#39;Yxys&#39;].shape )</span>
            <span class="n">solution_info_indexed</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;xs&#39;</span> <span class="p">:</span> <span class="n">solution_info</span><span class="p">[</span><span class="s1">&#39;xs&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span>
                                     <span class="s1">&#39;Ms&#39;</span> <span class="p">:</span> <span class="n">solution_info</span><span class="p">[</span><span class="s1">&#39;Ms&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span>
                                     <span class="s1">&#39;primss&#39;</span> <span class="p">:</span> <span class="n">solution_info</span><span class="p">[</span><span class="s1">&#39;primss&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span>
                                     <span class="s1">&#39;Yxys&#39;</span> <span class="p">:</span> <span class="n">solution_info</span><span class="p">[</span><span class="s1">&#39;Yxys&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                                     <span class="p">}</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="nb">tuple</span><span class="p">):</span> <span class="c1"># one function for each objective:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">](</span><span class="n">spdi</span><span class="p">,</span> <span class="n">solution_info</span> <span class="o">=</span> <span class="n">solution_info_indexed</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># one function for multiple objectives for increased speed:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">](</span><span class="n">spdi</span><span class="p">,</span> <span class="n">solution_info</span> <span class="o">=</span> <span class="n">solution_info_indexed</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">[</span><span class="n">j</span><span class="p">])</span></div>
        
<div class="viewcode-block" id="ObjFcns._get_normalization_factors"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.ObjFcns._get_normalization_factors">[docs]</a>    <span class="k">def</span> <span class="nf">_get_normalization_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          Set normalization factor for F-calculation</span>
<span class="sd">          &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">f_normalize</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ft</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ft</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ft</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">f_normalize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ft</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">f_normalize</span><span class="p">[</span><span class="n">f_normalize</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f_normalize</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">f_normalize</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_normalize</span><span class="p">)</span></div>
                
<div class="viewcode-block" id="ObjFcns._get_fj_output_str"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.ObjFcns._get_fj_output_str">[docs]</a>    <span class="k">def</span> <span class="nf">_get_fj_output_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">obj_vals_ij</span><span class="p">,</span> <span class="n">F_ij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; get output string for objective function fj &quot;&quot;&quot;</span>
        <span class="n">output_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="nb">tuple</span><span class="p">):</span>
                <span class="n">output_str_sub</span> <span class="o">=</span> <span class="s1">&#39;(&#39;</span>
                <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="n">output_str_sub</span> <span class="o">=</span> <span class="n">output_str_sub</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">jj</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; = {:1.&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:1.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decimals</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">jj</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;f}, &#39;</span>
                <span class="n">output_str_sub</span> <span class="o">=</span> <span class="n">output_str_sub</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
                <span class="n">output_str_sub</span> <span class="o">=</span> <span class="n">output_str_sub</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">obj_vals_ij</span><span class="p">))</span>    
                <span class="n">output_str</span> <span class="o">=</span> <span class="n">output_str</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;Fobj_#</span><span class="si">{:1.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; = </span><span class="si">{:1.3f}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="n">output_str_sub</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
                <span class="n">output_str</span> <span class="o">=</span> <span class="n">output_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">F_ij</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;E</span><span class="si">{:1.2f}</span><span class="s1">(T</span><span class="si">{:1.2f}</span><span class="s1">), &#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">obj_vals_ij</span><span class="p">)</span>
                <span class="n">fmt_values</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">targetvals</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ft</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ft</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="nb">list</span><span class="p">))</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ft</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obj_vals_ij</span><span class="p">)):</span> <span class="n">fmt_values</span> <span class="o">=</span> <span class="n">fmt_values</span> <span class="o">+</span> <span class="p">[</span><span class="n">obj_vals_ij</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">targetvals</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
                <span class="n">output_str</span> <span class="o">=</span> <span class="n">output_str</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;Fobj_#</span><span class="si">{:1.0f}</span><span class="s1"> = &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">fmt_values</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">output_str</span></div></div>
            
        
        
<div class="viewcode-block" id="Minimizer"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.Minimizer">[docs]</a><span class="k">class</span> <span class="nc">Minimizer</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">,</span> <span class="n">opts</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">x0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pareto</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">display</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize minimization method.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            :method:</span>
<span class="sd">                | &#39;Nelder-Mead&#39;, optional</span>
<span class="sd">                | Optimization method used by minimize function.</span>
<span class="sd">                | options: </span>
<span class="sd">                |   - &#39;Nelder-Mead&#39;: Nelder-Mead simplex local optimization </span>
<span class="sd">                |                    using the luxpy.math.minimizebnd wrapper</span>
<span class="sd">                |                    with method set to &#39;Nelder-Mead&#39;.</span>
<span class="sd">                |   - &#39;demo&#39; :  Differential Evolutionary Multiobjective Optimizatizer</span>
<span class="sd">                |               (using math.DEMO.demo_opt)</span>
<span class="sd">                |   - &#39;particleswarm&#39;: Pseudo-global optimizer using particle swarms</span>
<span class="sd">                |                      (from pyswarm wrapper module luxpy.math.pyswarms_particleswarm)</span>
<span class="sd">                |   - &#39;nsga_ii&#39;: Pareto multiobjective optimizer using the NSGA-II genetic algorithm</span>
<span class="sd">                |                      (from pymoo wrapper module luxpy.math.pymoo_nsga_ii)</span>
<span class="sd">                |   - A user-defined minimization function (see minimizer.apply? for </span>
<span class="sd">                |       info on the requirements of this function)</span>
<span class="sd">            :opts:</span>
<span class="sd">                | None, optional</span>
<span class="sd">                | Dict with minimization options. </span>
<span class="sd">                | None defaults to the options depending on choice of method</span>
<span class="sd">                |  - &#39;Nelder-Mead&#39;   : {&#39;xtol&#39;: 1e-5, &#39;disp&#39;: True, &#39;maxiter&#39;: 1000*Nc,</span>
<span class="sd">                |                       &#39;maxfev&#39; : 1000*Nc,&#39;fatol&#39;: 0.01}</span>
<span class="sd">                |  - &#39;demo&#39; :          {&#39;F&#39;: 0.5, &#39;CR&#39;: 0.3, &#39;kmax&#39;: 300, &#39;mu&#39;: 100, &#39;display&#39;: True}</span>
<span class="sd">                |  - &#39;particleswarm&#39; : {&#39;iters&#39;: 100, &#39;n_particles&#39;: 10, &#39;ftol&#39;: -np.inf,</span>
<span class="sd">                |                       &#39;ps_opts&#39; : {&#39;c1&#39;: 0.5, &#39;c2&#39;: 0.3, &#39;w&#39;:0.9}}</span>
<span class="sd">                |  - &#39;nsga_ii&#39; : {&#39;n_gen&#39; : 40, &#39;n_pop&#39; : 400, &#39;n_offsprings&#39; : None,</span>
<span class="sd">                |                 &#39;termination&#39; : (&#39;n_gen&#39; , 40), &#39;seed&#39; : 1,</span>
<span class="sd">                |                 &#39;ga_opts&#39; : {&#39;sampling&#39;  : (&quot;real_random&quot;,{}),</span>
<span class="sd">                |                              &#39;crossover&#39; : (&quot;real_sbx&quot;, {&#39;prob&#39; : 0.9, &#39;eta&#39; : 15}),</span>
<span class="sd">                |                              &#39;mutation&#39;  : (&quot;real_pm&quot;,  {&#39;eta&#39; : 20})}}</span>
<span class="sd">                |  - dict with options for user-defined minimization method.</span>
<span class="sd">            :pareto:</span>
<span class="sd">                | False, optional</span>
<span class="sd">                | Specifies whether the output of the fitnessfcn should be the Root-Sum-of-Squares </span>
<span class="sd">                | of all weighted objective function values or not. Individual function values are</span>
<span class="sd">                | required by true multi-objective optimizers (i.e. pareto == True).</span>
<span class="sd">            :x0:</span>
<span class="sd">                | None, optional</span>
<span class="sd">                | Lets the user specify an optional starting value required by </span>
<span class="sd">                | some minimizers (eg. &#39;Nelder-Mead&#39;). It should contain only </span>
<span class="sd">                | values for the free parameters in the primary constructor.</span>
<span class="sd">            :display:</span>
<span class="sd">                | True, optional</span>
<span class="sd">                | Turn native display options of minimizers on (True) or off (False).</span>

<span class="sd">        Notes on the user-defined minimizers:</span>
<span class="sd">            </span>
<span class="sd">            1. Must be initialzed using class Minimizer!</span>
<span class="sd">            2. If not isinstance(minimizer.method, str): </span>
<span class="sd">                | then it should contain an minimization funtion with the following interface: </span>
<span class="sd">                |     results = minimizer.method(fitnessfcn, npars, args = {}, bounds = (lb, ub), verbosity = 1)</span>
<span class="sd">                | With &#39;results&#39; a dictionary containing various variables related to the optimization. </span>
<span class="sd">                |  - It MUST contain a key &#39;x_final&#39; containing the final optimized parameters.</span>
<span class="sd">                |  - bnds must be [lowerbounds, upperbounds] with x-bounds ndarrays with values for each parameter.</span>
<span class="sd">                |  - args is an argument with a dictionary containing the input arguments to the fitnessfcn.         </span>
<span class="sd">            3. Minimizer built-in options &#39;particleswarm&#39; and &#39;nsga_ii&#39; require</span>
<span class="sd">            pyswarms and pymoo packages to be installed. To minimize the dependency list </span>
<span class="sd">            of luxpy on &#39;specialized&#39; packages, these are not automatically installed</span>
<span class="sd">            along with luxpy. However, an attempt will be made to pip install them</span>
<span class="sd">            on first import (so please be patient when running these options for the first</span>
<span class="sd">            time). If the pip install fails, try a manual install using either pip or conda.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="o">=</span> <span class="n">opts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pareto</span> <span class="o">=</span> <span class="n">pareto</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display</span> <span class="o">=</span> <span class="n">display</span>
        
        <span class="c1"># Setup default optmization options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_defopts_and_pareto</span><span class="p">(</span><span class="n">pareto</span> <span class="o">=</span> <span class="n">pareto</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">display</span> <span class="o">=</span> <span class="n">display</span><span class="p">)</span>
        
<div class="viewcode-block" id="Minimizer._set_defopts_and_pareto"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.Minimizer._set_defopts_and_pareto">[docs]</a>    <span class="k">def</span> <span class="nf">_set_defopts_and_pareto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pareto</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">display</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set default options if not provided, as well as pareto (False: output Root-Sum-Squares of Fi in _fitnessfcn).</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">display</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">display</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display</span> <span class="o">=</span> <span class="n">display</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;particleswarm&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ps&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pareto</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;demo&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;nsga_ii&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pareto</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># must be output per objective function!!</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;pareto&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pareto</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;pareto&#39;</span><span class="p">]</span>
    
        <span class="c1"># create dictionary with defaults options</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">):</span>
            <span class="n">npar</span> <span class="o">=</span> <span class="mi">10</span> <span class="k">if</span> <span class="n">x0</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
            <span class="n">tmp_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;xtol&#39;</span><span class="p">:</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">:</span> <span class="n">display</span><span class="p">,</span> <span class="s1">&#39;maxiter&#39;</span> <span class="p">:</span> <span class="mi">1000</span><span class="o">*</span><span class="n">npar</span><span class="p">,</span> <span class="s1">&#39;maxfev&#39;</span> <span class="p">:</span> <span class="mi">1000</span><span class="o">*</span><span class="n">npar</span><span class="p">,</span><span class="s1">&#39;fatol&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">}</span>

        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;demo&#39;</span><span class="p">):</span>
            <span class="n">tmp_opts</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">DEMO</span><span class="o">.</span><span class="n">init_options</span><span class="p">(</span><span class="n">display</span> <span class="o">=</span> <span class="n">display</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;particleswarm&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ps&#39;</span><span class="p">):</span>
            <span class="n">tmp_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;iters&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;n_particles&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;ftol&#39;</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                              <span class="s1">&#39;ps_opts&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;c1&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span><span class="mf">0.9</span><span class="p">}}</span>
            
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;nsga_ii&#39;</span><span class="p">):</span>
            <span class="n">tmp_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;n_gen&#39;</span> <span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="s1">&#39;n_pop&#39;</span> <span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;n_offsprings&#39;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="s1">&#39;termination&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;n_gen&#39;</span> <span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="s1">&#39;seed&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                          <span class="s1">&#39;ga_opts&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;sampling&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&quot;real_random&quot;</span><span class="p">,{}),</span>
                                      <span class="s1">&#39;crossover&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;real_sbx&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;prob&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span> <span class="s1">&#39;eta&#39;</span> <span class="p">:</span> <span class="mi">15</span><span class="p">}),</span>
                                      <span class="s1">&#39;mutation&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="s2">&quot;real_pm&quot;</span><span class="p">,</span>  <span class="p">{</span><span class="s1">&#39;eta&#39;</span> <span class="p">:</span> <span class="mi">20</span><span class="p">})}}</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">tmp_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;user-defined, specified as part of opt. function definition&#39;</span><span class="p">}</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;User-Defined minimizer: user should (have) set the optimization options when defining minimizer!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span> <span class="p">(</span><span class="s1">&#39;Unsupported minimization method.&#39;</span><span class="p">)</span>   

        <span class="c1"># Update defaults with user entries:</span>
        <span class="n">tmp_opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">)</span>
        
        <span class="c1"># overwrite existing self.opts with new entries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="o">=</span> <span class="n">tmp_opts</span>                      </div>
                    
<div class="viewcode-block" id="Minimizer.apply"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.Minimizer.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitness_fcn</span><span class="p">,</span> <span class="n">npars</span><span class="p">,</span> <span class="n">fitness_args_dict</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run minimizer on fitness function with specified fitness_args_dict input arguments and bounds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fitness_args_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">fitness_args_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;display&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">verbosity</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
         
        <span class="c1"># Local Simplex optimization using Nelder-Mead:</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">],</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bounds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span><span class="o">.</span><span class="n">T</span> <span class="c1"># generate random start value within bounds</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x0_triangle_strengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">npars</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">)))</span><span class="c1">#np.array([np.random.uniform(bnds[0,i+2*n], bnds[1,i+2*n],1) for i in range(n_triangle_strengths)]).T</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">x0_triangle_strengths</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x0</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x0_with_triangle_strengths</span> <span class="o">=</span> <span class="n">x0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;disp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;display&#39;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">minimizebnd</span><span class="p">(</span><span class="n">fitness_fcn</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">fitness_args_list</span><span class="p">),</span> <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">use_bnd</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">)</span>

        <span class="c1"># Differential Evolutionary Multi-Objective Optimization:</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;demo&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span> 
                <span class="n">xrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="kc">None</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Minimizer: Must set bnds for the &#39;demo&#39; minimizer&quot;</span><span class="p">)</span>
            <span class="n">fopt</span><span class="p">,</span> <span class="n">xopt</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">DEMO</span><span class="o">.</span><span class="n">demo_opt</span><span class="p">(</span><span class="n">fitness_fcn</span><span class="p">,</span> <span class="n">npars</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">fitness_args_list</span><span class="p">,</span> <span class="n">xrange</span> <span class="o">=</span> <span class="n">xrange</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_final&#39;</span><span class="p">:</span> <span class="n">xopt</span><span class="p">,</span><span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="n">fopt</span><span class="p">}</span>
        
        <span class="c1"># Particle swarm optimization:</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;particleswarm&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ps&#39;</span><span class="p">):</span>
            
            <span class="c1"># import required minimizer function:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">luxpy.math.pyswarms_particleswarm</span> <span class="kn">import</span> <span class="n">particleswarm</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Could not import particleswarm(), try a manual install of the &#39;pyswarms&#39; package&quot;</span><span class="p">)</span>
            
            <span class="c1"># run minimizer:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">particleswarm</span><span class="p">(</span><span class="n">fitness_fcn</span><span class="p">,</span> <span class="n">npars</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">fitness_args_dict</span><span class="p">,</span> <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> 
                                    <span class="n">iters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;iters&#39;</span><span class="p">],</span> <span class="n">n_particles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;n_particles&#39;</span><span class="p">],</span>
                                    <span class="n">ftol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;ftol&#39;</span><span class="p">],</span> <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;ps_opts&#39;</span><span class="p">],</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>
       
        <span class="c1"># NSGA-II optimization:</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;nsga_ii&#39;</span><span class="p">):</span>
            
            <span class="c1"># import required minimizer function:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">luxpy.math.pymoo_nsga_ii</span> <span class="kn">import</span> <span class="n">nsga_ii</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Could not import nsga_ii(), try a manual install of the &#39;pymoo&#39; package&quot;</span><span class="p">)</span>
            
            <span class="c1"># run minimizer:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">nsga_ii</span><span class="p">(</span><span class="n">fitness_fcn</span><span class="p">,</span> <span class="n">npars</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">fitness_args_dict</span><span class="p">,</span> <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> 
                              <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">,</span> <span class="n">pm_seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">],</span>
                              <span class="n">pm_n_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;n_gen&#39;</span><span class="p">],</span> <span class="n">pm_n_pop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;n_pop&#39;</span><span class="p">],</span> 
                              <span class="n">pm_n_offsprings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;n_offsprings&#39;</span><span class="p">],</span>
                              <span class="n">pm_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;ga_opts&#39;</span><span class="p">],</span>
                              <span class="n">pm_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;termination&#39;</span><span class="p">])</span>    

                
        <span class="c1"># Run user defined optimization algorithm:</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="n">fitness_fcn</span><span class="p">,</span> 
                                  <span class="n">npars</span><span class="p">,</span> 
                                  <span class="n">args</span> <span class="o">=</span> <span class="n">fitness_args_dict</span><span class="p">,</span> 
                                  <span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">,</span> 
                                  <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">,</span> 
                                  <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span> <span class="p">(</span><span class="s1">&#39;Unsupported minimization method.&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span></div></div>
        
<div class="viewcode-block" id="SpectralOptimizer"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.SpectralOptimizer">[docs]</a><span class="k">class</span> <span class="nc">SpectralOptimizer</span><span class="p">():</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">target</span> <span class="o">=</span> <span class="n">np2d</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">]),</span> <span class="n">tar_type</span> <span class="o">=</span> <span class="s1">&#39;Yxy&#39;</span><span class="p">,</span> <span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="p">{},</span>
                  <span class="n">nprim</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wlr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">360</span><span class="p">,</span><span class="mi">830</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">cieobs</span> <span class="o">=</span> <span class="n">_CIEOBS</span><span class="p">,</span> 
                  <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;spds,primss,Ms,results&#39;</span><span class="p">,</span>
                  <span class="n">optimizer_type</span> <span class="o">=</span> <span class="s1">&#39;3mixer&#39;</span><span class="p">,</span> <span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">prim_constructor</span> <span class="o">=</span> <span class="n">PrimConstructor</span><span class="p">(),</span> <span class="n">prims</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">obj_fcn</span> <span class="o">=</span> <span class="n">ObjFcns</span><span class="p">(),</span>
                  <span class="n">minimizer</span> <span class="o">=</span> <span class="n">Minimizer</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">),</span>
                  <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        | Initialize instance of SpectralOptimizer to generate a spectrum with </span>
<span class="sd">        | specified white point and optimized for certain objective functions </span>
<span class="sd">        | from a set of primary spectra or primary spectrum model parameters.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            :target: </span>
<span class="sd">                | np2d([100,1/3,1/3]), optional</span>
<span class="sd">                | ndarray with Yxy chromaticity of target.</span>
<span class="sd">            :tar_type:</span>
<span class="sd">                | &#39;Yxy&#39; or str, optional</span>
<span class="sd">                | Specifies the input type in :target: (e.g. &#39;Yxy&#39; or &#39;cct&#39;)</span>
<span class="sd">            :cspace_bwtf:</span>
<span class="sd">                | {}, optional</span>
<span class="sd">                | Backward (cspace_to_xyz) transform parameters </span>
<span class="sd">                | (see colortf()) to go from :tar_type: to &#39;Yxy&#39;).</span>
<span class="sd">            :nprim:</span>
<span class="sd">                | 4, optional</span>
<span class="sd">                | Number of primaries in light mixture.</span>
<span class="sd">            :wl: </span>
<span class="sd">                | [360,830,1], optional</span>
<span class="sd">                | Wavelengths used in optimization when :prims: is not an</span>
<span class="sd">                |  ndarray with spectral data.</span>
<span class="sd">            :cieobs:</span>
<span class="sd">                | _CIEOBS, optional</span>
<span class="sd">                | CIE CMF set used to calculate chromaticity values, if not provided </span>
<span class="sd">                |  in :Yxyi:.</span>
<span class="sd">            :optimizer_type:</span>
<span class="sd">                | &#39;3mixer&#39;,  optional</span>
<span class="sd">                | Specifies type of chromaticity optimization </span>
<span class="sd">                | options: &#39;3mixer&#39;, &#39;no-mixer&#39;</span>
<span class="sd">                | For a short description of &#39;3mixer&#39; and &#39;no-mixer algorithms,</span>
<span class="sd">                | see notes below.</span>
<span class="sd">            :triangle_strengths_bnds:</span>
<span class="sd">                | None, optional</span>
<span class="sd">                | Bounds for the strengths of the triangle contributions (&#39;3mixer&#39;)</span>
<span class="sd">                | or individual primary contributions (&#39;no-mixer&#39;).</span>
<span class="sd">                | If None: bounds are set between [0,1].</span>
<span class="sd">            :prims:</span>
<span class="sd">                | ndarray of predefined primary spectra.</span>
<span class="sd">                | If None: they are built from optimization parameters using the </span>
<span class="sd">                | function in :prim_constructor:</span>
<span class="sd">            :prim_constructor:</span>
<span class="sd">                | PrimConstructor(), optional</span>
<span class="sd">                | Instance of class PrimConstructor that has an attribute with a</span>
<span class="sd">                | function that constructs the primaries from a set of parameters.</span>
<span class="sd">                | PrimConstructor.f() should have the form: </span>
<span class="sd">                |   prim_constructor(x, n, wl, ptypes, **pdefs)</span>
<span class="sd">                | see PrimConstructor.__docstring__ for more info.</span>
<span class="sd">            :obj_fcn:</span>
<span class="sd">                | ObjFcns(), optional</span>
<span class="sd">                | Instance of class ObjFcns that holds objective functions, their </span>
<span class="sd">                | input arguments, target values, and relative weighting factors </span>
<span class="sd">                | (for pseudo multi-objective optimization).</span>
<span class="sd">                | Notes: </span>
<span class="sd">                |       1. The objective value F_j for each objective function f_j is calculated as: </span>
<span class="sd">                |            F_j = (fw_j*abs((f_j(x)-ft_j)/ft_j)) </span>
<span class="sd">                |       2. If ft_j==0 then ft_j in the denominator is set to 1 to avoid division by zero.</span>
<span class="sd">            :minimizer:</span>
<span class="sd">                | Minimizer(method=&#39;Nelder-Mead&#39;), optional</span>
<span class="sd">                | Instance of the Minimizer class.</span>
<span class="sd">                | See Minimizer.__docstring__ for more info.</span>
<span class="sd">            :verbosity:</span>
<span class="sd">                | 0, optional</span>
<span class="sd">                | If &gt; 0: print intermediate results </span>
<span class="sd">                | (&gt; 1 gives even more output for some options).</span>
<span class="sd">            :out:</span>
<span class="sd">                | &#39;spds,primss,Ms,results&#39;, optional</span>
<span class="sd">                | Determines output of function (see :returns:).</span>
<span class="sd">                </span>
<span class="sd">        Returns:</span>
<span class="sd">            :returns: </span>
<span class="sd">                | spds, primss,Ms,results</span>
<span class="sd">                | - &#39;spds&#39;: optimized spectrum (or spectra: for demo, particleswarm and nsga_ii minimization methods)</span>
<span class="sd">                | - &#39;primss&#39;: primary spectra of each optimized spectrum</span>
<span class="sd">                | - &#39;Ms&#39; : ndarrays with fluxes of each primary</span>
<span class="sd">                | - &#39;results&#39;: dict with optimization results</span>
<span class="sd">                |</span>
<span class="sd">                | Also see attribute &#39;optim_results&#39; of class instance for info</span>
<span class="sd">                | on spds, prims, Ms, Yxy_estimate, obj_fcn.f function values and x_final.</span>
<span class="sd">    </span>
<span class="sd">        Notes on the optimization algorithms:</span>
<span class="sd">             </span>
<span class="sd">            1. &#39;3mixer&#39;: The triangle/trio method creates for all possible </span>
<span class="sd">            combinations of 3 primary component spectra a spectrum that results in </span>
<span class="sd">            the target chromaticity using color3mixer() and then optimizes the </span>
<span class="sd">            weights of each of the latter spectra such that adding them </span>
<span class="sd">            (additive mixing) results in obj_vals as close as possible to the </span>
<span class="sd">            target values.</span>
<span class="sd">           </span>
<span class="sd">            2. &#39;2mixer&#39;:</span>
<span class="sd">            APRIL 2020, NOT YET IMPLEMENTED!!</span>
<span class="sd">            Pairs (odd,even) of components are selected and combined using </span>
<span class="sd">            &#39;pair_strength&#39;. This process is continued until only 3 (combined)</span>
<span class="sd">            intermediate sources remain. Color3mixer is then used to calculate </span>
<span class="sd">            the fluxes for the remaining 3 sources, after which the fluxes of </span>
<span class="sd">            all components are back-calculated.</span>
<span class="sd">            </span>
<span class="sd">            3. &#39;no-mixer&#39;:</span>
<span class="sd">            Spectrum is created as weighted sum of primaries. Any desired target </span>
<span class="sd">            chromaticity should be specified as part of the objective functions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tar_type</span> <span class="o">=</span> <span class="n">tar_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="n">cspace_bwtf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nprim</span> <span class="o">=</span> <span class="n">nprim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wlr</span> <span class="o">=</span> <span class="n">getwlr</span><span class="p">(</span><span class="n">wlr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_target</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">tar_type</span><span class="p">,</span> <span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="n">cspace_bwtf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cieobs</span> <span class="o">=</span> <span class="n">cieobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">out</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_type</span> <span class="o">=</span> <span class="n">optimizer_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span>
        
        <span class="c1"># Setup primaries using either a PrimConstructor object or an ndarray:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prim_constructor</span><span class="p">,</span><span class="n">PrimConstructor</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">prim_constructor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prim_constructor</span> <span class="o">=</span> <span class="n">PrimConstructor</span><span class="p">(</span><span class="n">prim_constructor</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;prim_constructor argument not an instance of class PrimConstructor! Initializing as instance with defaults: pars = [&#39;peakwl&#39;, &#39;fwhm&#39;], opts = </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prim_constructor</span> <span class="o">=</span> <span class="n">PrimConstructor</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prim_constructor</span> <span class="o">=</span> <span class="n">prim_constructor</span>
        <span class="n">prim_constructor_pdefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prim_constructor</span><span class="o">.</span><span class="n">pdefs</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_nprim_prims</span><span class="p">(</span><span class="n">nprim</span> <span class="o">=</span> <span class="n">nprim</span><span class="p">,</span> <span class="n">prims</span> <span class="o">=</span> <span class="n">prims</span><span class="p">)</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">obj_fcn</span> <span class="o">=</span> <span class="n">obj_fcn</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">minimizer</span><span class="p">,</span><span class="n">Minimizer</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span> <span class="o">=</span> <span class="n">Minimizer</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">minimizer</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;minimizer argument not an instance of class Minimizer! Initializing as instance with defaults: opts = </span><span class="si">{}</span><span class="s2">, x0 = None, display = True, pareto = False.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span> <span class="o">=</span> <span class="n">minimizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optim_results</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;spd&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;prims&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Yxy_est&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;obj_fv&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span><span class="s1">&#39;x_final&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>

        <span class="c1"># a. update fixed prim constructor pars and setup bound for free parameters</span>
        <span class="c1"># b. update triangle_strengths_bnds</span>
        <span class="c1"># c. construct a self.bnds attribute with bounds on triangle_strengths and all free parameters for an n-primary mixture.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_bnds</span><span class="p">(</span><span class="n">nprim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprim</span><span class="p">,</span> <span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="n">triangle_strengths_bnds</span><span class="p">,</span> <span class="o">**</span><span class="n">prim_constructor_pdefs</span><span class="p">)</span>
<span class="c1">#        self.update(nprim = self.nprim, cieobs = self.cieobs, target = self.target, tar_type = self.tar_type, cspace_bwtf = self.cspace_bwtf,</span>
<span class="c1">#               triangle_strengths_bnds = triangle_strengths_bnds, **self.prim_constructor.pdefs)</span>

<div class="viewcode-block" id="SpectralOptimizer._update_nprim_prims"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.SpectralOptimizer._update_nprim_prims">[docs]</a>    <span class="k">def</span> <span class="nf">_update_nprim_prims</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nprim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prims</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update prims (and nprim).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prims</span> <span class="o">=</span> <span class="n">prims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nprim</span> <span class="o">=</span> <span class="n">nprim</span>
        <span class="k">if</span> <span class="n">prims</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nprim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">nprim</span> <span class="o">=</span> <span class="n">prims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nprim</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">nprim</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nprim</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nprim</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">prims</span> <span class="o">=</span> <span class="n">prims</span><span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">nprim</span><span class="p">,:]</span> <span class="c1"># select specific prims in list</span>
            <span class="n">nprim</span> <span class="o">=</span> <span class="n">prims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> <span class="c1"># set nprim</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prims</span> <span class="o">=</span> <span class="n">prims</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nprim</span> <span class="o">=</span> <span class="n">nprim</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wlr</span> <span class="o">=</span> <span class="n">prims</span><span class="p">[:</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_type</span> <span class="o">==</span> <span class="s1">&#39;3mixer&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;nprim-error: number of primaries for optimizer_type == &#39;3mixer&#39; should be minimum 3!&quot;</span><span class="p">)</span></div>
        
        

<div class="viewcode-block" id="SpectralOptimizer._update_target"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.SpectralOptimizer._update_target">[docs]</a>    <span class="k">def</span> <span class="nf">_update_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tar_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update target chromaticity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
        <span class="k">if</span> <span class="n">tar_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">tar_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tar_type</span>
        <span class="k">if</span> <span class="n">cspace_bwtf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cspace_bwtf</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Yxy_target</span> <span class="o">=</span> <span class="n">colortf</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">tf</span> <span class="o">=</span> <span class="n">tar_type</span><span class="o">+</span><span class="s1">&#39;&gt;Yxy&#39;</span><span class="p">,</span> <span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="n">cspace_bwtf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Yxy_target</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tar_type</span> <span class="o">=</span> <span class="n">tar_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="n">cspace_bwtf</span>
        <span class="k">if</span> <span class="s1">&#39;cieobs&#39;</span> <span class="ow">in</span> <span class="n">cspace_bwtf</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cieobs</span> <span class="o">=</span> <span class="n">cspace_bwtf</span><span class="p">[</span><span class="s1">&#39;cieobs&#39;</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="SpectralOptimizer._update_prim_pars_bnds"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.SpectralOptimizer._update_prim_pars_bnds">[docs]</a>    <span class="k">def</span> <span class="nf">_update_prim_pars_bnds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nprim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get and set fixed and free parameters, as well as bnds on latter for an nprim primary mixture.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nprim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprim</span> <span class="o">=</span> <span class="n">nprim</span>
        <span class="n">fixed_pars_defs</span><span class="p">,</span><span class="n">free_pars_bnds</span><span class="p">,</span><span class="n">free_pars</span> <span class="o">=</span> <span class="n">_get_default_prim_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nprim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prim_constructor</span><span class="o">.</span><span class="n">ptypes</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prim_constructor</span><span class="o">.</span><span class="n">pdefs</span> <span class="o">=</span> <span class="n">fixed_pars_defs</span> <span class="c1"># update prim_constructor with defaults for fixed parameters </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">free_pars</span> <span class="o">=</span> <span class="n">free_pars</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">free_pars_bnds</span> <span class="o">=</span> <span class="n">free_pars_bnds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># in case of self.prim not None: then there are no bounds on </span>
            <span class="c1"># those parameters (only triangle_strengths are free)!!</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prim_constructor</span><span class="o">.</span><span class="n">ptypes</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prim_constructor</span><span class="o">.</span><span class="n">pdefs</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fixed_primary_set&#39;</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">free_pars_bnds</span> <span class="o">=</span> <span class="p">{</span><span class="n">pt</span><span class="o">+</span><span class="s1">&#39;_bnds&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">free_pars_bnds</span><span class="p">[</span><span class="n">pt</span><span class="o">+</span><span class="s1">&#39;_bnds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">free_pars</span> <span class="o">=</span> <span class="p">[]</span></div>
                
            
<div class="viewcode-block" id="SpectralOptimizer._update_triangle_strengths_bnds"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.SpectralOptimizer._update_triangle_strengths_bnds">[docs]</a>    <span class="k">def</span> <span class="nf">_update_triangle_strengths_bnds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nprim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update bounds of triangle_strengths for for an nprim primary mixture.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nprim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprim</span> <span class="o">=</span> <span class="n">nprim</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_type</span> <span class="o">==</span> <span class="s1">&#39;3mixer&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_triangle_strengths</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nprim</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nprim</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="n">_parse_bnds</span><span class="p">(</span><span class="n">triangle_strengths_bnds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_triangle_strengths</span><span class="p">,</span> <span class="n">min_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_type</span> <span class="o">==</span> <span class="s1">&#39;no-mixer&#39;</span><span class="p">:</span> <span class="c1"># use triangle_strengths to store info on primary strengths in case of &#39;no-mixer&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_triangle_strengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprim</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="n">_parse_bnds</span><span class="p">(</span><span class="n">triangle_strengths_bnds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_triangle_strengths</span><span class="p">,</span> <span class="n">min_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="SpectralOptimizer._update_bnds"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.SpectralOptimizer._update_bnds">[docs]</a>    <span class="k">def</span> <span class="nf">_update_bnds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nprim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">prim_kwargs</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update all bounds (triangle_strengths and those of free parameters of primary constructor) for an nprim primary mixture..</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nprim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprim</span> <span class="o">=</span> <span class="n">nprim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_prim_pars_bnds</span><span class="p">(</span><span class="n">nprim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprim</span><span class="p">,</span> <span class="o">**</span><span class="n">prim_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_triangle_strengths_bnds</span><span class="p">(</span><span class="n">nprim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprim</span><span class="p">,</span> <span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="n">triangle_strengths_bnds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bnds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangle_strengths_bnds</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_pars_bnds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> 
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># in case of self.prim not None!!</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bnds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">bnds</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npars</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_triangle_strengths</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">free_pars</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nprim</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="SpectralOptimizer.update"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.SpectralOptimizer.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nprim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prims</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cieobs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tar_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">prim_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates all that is needed when one of the input arguments is changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cieobs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cieobs</span> <span class="o">=</span> <span class="n">cieobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_target</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">,</span> <span class="n">tar_type</span> <span class="o">=</span> <span class="n">tar_type</span><span class="p">,</span> <span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="n">cspace_bwtf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_nprim_prims</span><span class="p">(</span><span class="n">nprim</span> <span class="o">=</span> <span class="n">nprim</span><span class="p">,</span> <span class="n">prims</span> <span class="o">=</span> <span class="n">prims</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_bnds</span><span class="p">(</span><span class="n">nprim</span> <span class="o">=</span> <span class="n">nprim</span><span class="p">,</span> <span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="n">triangle_strengths_bnds</span><span class="p">,</span> <span class="o">**</span><span class="n">prim_kwargs</span><span class="p">)</span></div>
        

<div class="viewcode-block" id="SpectralOptimizer._spd_constructor_tri"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.SpectralOptimizer._spd_constructor_tri">[docs]</a>    <span class="k">def</span> <span class="nf">_spd_constructor_tri</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a mixture spectrum composed of n primaries using the 3mixer algorithm.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            :x:</span>
<span class="sd">                | optimization parameters, first n!/(n-3)!*3! are the strengths of</span>
<span class="sd">                | the triangles in the &#39;3mixer&#39; algorithm.</span>
<span class="sd">                           </span>
<span class="sd">        Returns:</span>
<span class="sd">            :spd, prims, M:</span>
<span class="sd">                | - spd: spectrum resulting from x</span>
<span class="sd">                | - spds: primary spds</span>
<span class="sd">                | - M: fluxes of all primaries</span>
<span class="sd">                </span>
<span class="sd">        Notes:</span>
<span class="sd">            1. &#39;3mixer&#39; - optimization algorithm: The triangle/trio method creates </span>
<span class="sd">            for all possible combinations of 3 primary component spectra a spectrum</span>
<span class="sd">            that results in the target chromaticity using color3mixer() and then </span>
<span class="sd">            optimizes the weights of each of the latter spectra such that adding </span>
<span class="sd">            them (additive mixing) results in obj_vals as close as possible to </span>
<span class="sd">            the target values.</span>
<span class="sd">    </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># get primary spectra:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># get triangle_strengths and remove them from x, remaining x are used to construct primaries:</span>
            <span class="n">triangle_strengths</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_triangle_strengths</span><span class="p">]</span>
            
            <span class="n">prims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prim_constructor</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">n_triangle_strengths</span><span class="p">:],</span> 
                                            <span class="bp">self</span><span class="o">.</span><span class="n">nprim</span><span class="p">,</span> 
                                            <span class="bp">self</span><span class="o">.</span><span class="n">wlr</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">prim_constructor</span><span class="o">.</span><span class="n">ptypes</span><span class="p">,</span>
                                            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">prim_constructor</span><span class="o">.</span><span class="n">pdefs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">prims</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">prims</span> <span class="o">=</span> <span class="n">prims</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="c1"># ensure 3D-shape!! </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">triangle_strengths</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">prims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prims</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">prims</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">prims</span> <span class="o">=</span> <span class="n">prims</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
            <span class="n">prims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">prims</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
           
        <span class="c1"># reshape prims for colortf:</span>
        <span class="n">wlr_</span> <span class="o">=</span> <span class="n">prims</span><span class="p">[</span><span class="mi">0</span><span class="p">,:</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="n">prims_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">wlr_</span><span class="p">,</span><span class="n">prims</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">prims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">prims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">prims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>

        <span class="c1"># get primary chrom. coords.:</span>
        <span class="n">Yxyi</span> <span class="o">=</span> <span class="n">colortf</span><span class="p">(</span><span class="n">prims_</span><span class="p">,</span><span class="n">tf</span><span class="o">=</span><span class="s1">&#39;spd&gt;Yxy&#39;</span><span class="p">,</span><span class="n">bwtf</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cieobs&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">cieobs</span><span class="p">,</span><span class="s1">&#39;relative&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>
        
        <span class="c1"># reshape (N,nprims,3):</span>
        <span class="n">Yxyi</span> <span class="o">=</span> <span class="n">Yxyi</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">prims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">prims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Get fluxes of each primary:</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">_triangle_mixer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Yxy_target</span><span class="p">,</span> <span class="n">Yxyi</span><span class="p">,</span> <span class="n">triangle_strengths</span><span class="p">)</span>
        
        <span class="c1"># Scale M to have target Y:</span>
        <span class="n">isnan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">notnan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">isnan</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Yxy_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1">#if notnan.any(): M[notnan,:] = M[notnan,:]*(self.Yxy_target[...,0]/(Yxyi[notnan,:,0]*M[notnan,:]).sum(axis=-1,keepdims=True))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">notnan</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">notnan</span><span class="p">,:]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="n">notnan</span><span class="p">,:]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            
        <span class="c1"># Calculate optimized SPD:</span>
        <span class="n">spd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">wlr_</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ijk-&gt;ik&#39;</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">prims</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:,:])))</span>
       
        <span class="c1"># When out-of-gamut: set spd to NaN&#39;s:</span>
        <span class="n">spd</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:][</span><span class="n">isnan</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">spd</span><span class="p">,</span> <span class="n">prims</span><span class="p">,</span> <span class="n">M</span></div>
    
<div class="viewcode-block" id="SpectralOptimizer._spd_constructor_nomixer"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.SpectralOptimizer._spd_constructor_nomixer">[docs]</a>    <span class="k">def</span> <span class="nf">_spd_constructor_nomixer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a mixture spectrum composed of n primaries using no mixer algorithm (just simple weighted sum of primaries).</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            :x:</span>
<span class="sd">                | optimization parameters, first n are the strengths of individual primaries.</span>
<span class="sd">                           </span>
<span class="sd">        Returns:</span>
<span class="sd">            :spd, prims, M:</span>
<span class="sd">                | - spd: spectrum resulting from x</span>
<span class="sd">                | - spds: primary spds</span>
<span class="sd">                | - M: fluxes of all primaries</span>
<span class="sd">                </span>
<span class="sd">        Notes:</span>
<span class="sd">            1. &#39;no-mixer&#39; - simple weighted sum of primaries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># get primary spectra:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># get prim_strengths and remove them from x, remaining x are used to construct primaries:</span>
            <span class="n">prim_strengths</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">nprim</span><span class="p">]</span>
            
            <span class="n">prims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prim_constructor</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">nprim</span><span class="p">:],</span> 
                                            <span class="bp">self</span><span class="o">.</span><span class="n">nprim</span><span class="p">,</span> 
                                            <span class="bp">self</span><span class="o">.</span><span class="n">wlr</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">prim_constructor</span><span class="o">.</span><span class="n">ptypes</span><span class="p">,</span>
                                            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">prim_constructor</span><span class="o">.</span><span class="n">pdefs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">prims</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">prims</span> <span class="o">=</span> <span class="n">prims</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="c1"># ensure 3D-shape!! </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prim_strengths</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">prims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prims</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">prims</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">prims</span> <span class="o">=</span> <span class="n">prims</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
            <span class="n">prims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">prims</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># reshape prims for colortf:</span>
        <span class="n">wlr_</span> <span class="o">=</span> <span class="n">prims</span><span class="p">[</span><span class="mi">0</span><span class="p">,:</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="n">prims_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">wlr_</span><span class="p">,</span><span class="n">prims</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:,:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">prims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">prims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">prims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
        
        <span class="c1"># get primary chrom. coords.:</span>
        <span class="n">Yxyi</span> <span class="o">=</span> <span class="n">colortf</span><span class="p">(</span><span class="n">prims_</span><span class="p">,</span><span class="n">tf</span><span class="o">=</span><span class="s1">&#39;spd&gt;Yxy&#39;</span><span class="p">,</span><span class="n">bwtf</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cieobs&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">cieobs</span><span class="p">,</span><span class="s1">&#39;relative&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>

        <span class="c1"># reshape (N,nprims,3):</span>
        <span class="n">Yxyi</span> <span class="o">=</span> <span class="n">Yxyi</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">prims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">prims</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        
        <span class="c1"># Get fluxes of each primary:</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">prim_strengths</span>
        
        <span class="c1"># Scale M to have target Y:</span>
        <span class="n">isnan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">notnan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">isnan</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Yxy_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">notnan</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">M</span><span class="p">[</span><span class="n">notnan</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">notnan</span><span class="p">,:]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Yxy_target</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">Yxyi</span><span class="p">[</span><span class="n">notnan</span><span class="p">,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">M</span><span class="p">[</span><span class="n">notnan</span><span class="p">,:])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">notnan</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">notnan</span><span class="p">,:]</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="n">notnan</span><span class="p">,:]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            
        <span class="c1"># Calculate optimized SPD:</span>
        <span class="n">spd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">wlr_</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ijk-&gt;ik&#39;</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">prims</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:,:])))</span>

        <span class="c1"># When out-of-gamut: set spd to NaN&#39;s:</span>
        <span class="n">spd</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:][</span><span class="n">isnan</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">spd</span><span class="p">,</span> <span class="n">prims</span><span class="p">,</span> <span class="n">M</span></div>

<div class="viewcode-block" id="SpectralOptimizer._fitness_fcn"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.SpectralOptimizer._fitness_fcn">[docs]</a>    <span class="k">def</span> <span class="nf">_fitness_fcn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fitness function that calculates closeness of solution x to target values for specified objective functions. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># setup parameters for use in loop(s):</span>
        <span class="n">maxF</span> <span class="o">=</span> <span class="mf">1e00</span>
        <span class="n">F</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-16</span> <span class="c1">#avoid division by zero</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_fcn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">out</span> <span class="o">!=</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">obj_fcn_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_fcn</span><span class="o">.</span><span class="n">_equalize_sizes</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
    
        <span class="c1"># # Loop over all xi to get all spectra:</span>
        <span class="c1"># for i in range(x.shape[0]):</span>
            
        <span class="c1">#     # get spectrum for xi-parameters:</span>
        <span class="c1">#     xi = x[i:i+1,:]</span>
    
        <span class="c1">#     if self.optimizer_type == &#39;3mixer&#39;:</span>
        <span class="c1">#         spdi, primsi, Mi = self._spd_constructor_tri(xi)</span>
        <span class="c1">#     elif self.optimizer_type == &#39;no-mixer&#39;:</span>
        <span class="c1">#         spdi, primsi, Mi = self._spd_constructor_nomixer(xi)</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         raise Exception(&quot;Only the &#39;3mixer&#39; and &#39;nomixer&#39; optimizer type has been implemented so far (September 17, 2020)&quot;)</span>
            
        <span class="c1">#     if i == 0:</span>
        <span class="c1">#         spds = spdi</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         spds = np.vstack((spds,spdi[1,:]))</span>
            
        <span class="c1">#     # store output for all xi when not optimizing</span>
        <span class="c1">#     if out != &#39;F&#39;:</span>
        <span class="c1">#         if i == 0:</span>
        <span class="c1">#             Ms, primss= Mi, primsi</span>
        <span class="c1">#         else:</span>
        <span class="c1">#             Ms = np.vstack((Ms,Mi))</span>
        <span class="c1">#             primss = np.dstack((primss,primsi))</span>
        
        <span class="c1"># get all spectra:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_type</span> <span class="o">==</span> <span class="s1">&#39;3mixer&#39;</span><span class="p">:</span>
            <span class="n">spds</span><span class="p">,</span> <span class="n">primss</span><span class="p">,</span> <span class="n">Ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spd_constructor_tri</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_type</span> <span class="o">==</span> <span class="s1">&#39;no-mixer&#39;</span><span class="p">:</span>
            <span class="n">spds</span><span class="p">,</span> <span class="n">primss</span><span class="p">,</span> <span class="n">Ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spd_constructor_nomixer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Only the &#39;3mixer&#39; and &#39;nomixer&#39; optimizer type has been implemented so far (September 17, 2020)&quot;</span><span class="p">)</span>

             
        <span class="c1"># calculate for all spds at once:</span>
        <span class="n">Yxy_ests</span> <span class="o">=</span> <span class="n">colortf</span><span class="p">(</span><span class="n">spds</span><span class="p">,</span><span class="n">tf</span><span class="o">=</span><span class="s1">&#39;spd&gt;Yxy&#39;</span><span class="p">,</span><span class="n">bwtf</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cieobs&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">cieobs</span><span class="p">,</span><span class="s1">&#39;relative&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>

        <span class="c1"># calculate all objective functions on mass for all spectra:</span>
        <span class="n">isnan_spds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">spds</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_fcn</span><span class="o">.</span><span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            
            <span class="n">notnan_spds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">isnan_spds</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">notnan_spds</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">spds_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">spds</span><span class="p">[:</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">spds</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:][</span><span class="n">notnan_spds</span><span class="p">,:]))</span> <span class="c1"># only calculate spds that are not nan</span>
                
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_fcn</span><span class="o">.</span><span class="n">f</span><span class="p">)):</span>
                    
                    <span class="c1"># Calculate objective function j:</span>
                    <span class="n">obj_vals_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_fcn</span><span class="o">.</span><span class="n">_calculate_fj</span><span class="p">(</span><span class="n">spds_tmp</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="p">,</span> <span class="n">solution_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;xs&#39;</span> <span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s1">&#39;primss&#39;</span> <span class="p">:</span> <span class="n">primss</span><span class="p">,</span> <span class="s1">&#39;Ms&#39;</span><span class="p">:</span> <span class="n">Ms</span><span class="p">,</span> <span class="s1">&#39;Yxys&#39;</span> <span class="p">:</span> <span class="n">Yxy_ests</span><span class="p">,</span> <span class="s1">&#39;notnan_spds&#39;</span> <span class="p">:</span> <span class="n">notnan_spds</span><span class="p">})</span><span class="o">.</span><span class="n">T</span> 
                    
                    <span class="c1"># Round objective values:</span>
                    <span class="n">decimals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_fcn</span><span class="o">.</span><span class="n">decimals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">decimals</span><span class="p">,</span><span class="nb">tuple</span><span class="p">):</span> <span class="n">decimals</span> <span class="o">=</span> <span class="p">(</span><span class="n">decimals</span><span class="p">,)</span>
                    <span class="n">obj_vals_j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">obj_vals_j</span><span class="p">[:,</span><span class="n">ii</span><span class="p">],</span><span class="nb">int</span><span class="p">(</span><span class="n">decimals</span><span class="p">[</span><span class="n">ii</span><span class="p">]))</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">decimals</span><span class="p">))])</span><span class="o">.</span><span class="n">T</span>

                    
                    <span class="c1"># Store F-results in array: </span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">obj_vals_j</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_fcn</span><span class="o">.</span><span class="n">ft</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>
                    <span class="n">F_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_fcn</span><span class="o">.</span><span class="n">fw</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">delta</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_fcn</span><span class="o">.</span><span class="n">f_normalize</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>
                    
                    <span class="c1"># If within tolerance on target values, set F_j to zero:</span>
                    <span class="n">F_j</span><span class="p">[</span><span class="n">delta</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_fcn</span><span class="o">.</span><span class="n">ft_tol</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">F_tmp</span> <span class="o">=</span> <span class="n">F_j</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">F_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">F_tmp</span><span class="p">,</span> <span class="n">F_j</span><span class="p">))</span>
                        
                    <span class="k">if</span> <span class="p">(</span><span class="n">out</span> <span class="o">!=</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span> 
                        <span class="c1"># inflate to full size (including nan&#39;s):</span>
                        <span class="n">obs_vals_j_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">spds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">obj_vals_j</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">obs_vals_j_tmp</span><span class="p">[</span><span class="n">notnan_spds</span><span class="p">,:]</span> <span class="o">=</span>  <span class="n">obj_vals_j</span>
                        
                        <span class="c1"># store in array:</span>
                        <span class="n">obj_fcn_vals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs_vals_j_tmp</span>
    
                <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">spds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_fcn</span><span class="o">.</span><span class="n">nobjs</span><span class="p">))</span>
                <span class="n">F</span><span class="p">[</span><span class="n">notnan_spds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">F_tmp</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">spds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_fcn</span><span class="o">.</span><span class="n">nobjs</span><span class="p">))</span><span class="o">*</span><span class="n">maxF</span>
                
        <span class="c1"># Set output F, obj_vals_i when no objective functions were supplied:</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">F</span> <span class="o">=</span> <span class="p">((</span><span class="n">Yxy_ests</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Yxy_target</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="c1"># use distance to guide out-of-gamut solutions to in-gamut ones</span>
            <span class="n">F</span><span class="p">[</span><span class="n">isnan_spds</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">maxF</span>
        
        <span class="c1"># Print output:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Yxy_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">output_str</span> <span class="o">=</span> <span class="s1">&#39;spdi = </span><span class="si">{:1.0f}</span><span class="s1">/</span><span class="si">{:1.0f}</span><span class="s1">, chrom. = E(</span><span class="si">{:1.1f}</span><span class="s1">,</span><span class="si">{:1.4f}</span><span class="s1">,</span><span class="si">{:1.4f}</span><span class="s1">)/T(</span><span class="si">{:1.1f}</span><span class="s1">,</span><span class="si">{:1.4f}</span><span class="s1">,</span><span class="si">{:1.4f}</span><span class="s1">), &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Yxy_ests</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">Yxy_ests</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">Yxy_ests</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Yxy_target</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Yxy_target</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">Yxy_target</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>    
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output_str</span> <span class="o">=</span> <span class="s1">&#39;spdi = </span><span class="si">{:1.0f}</span><span class="s1">/</span><span class="si">{:1.0f}</span><span class="s1">, chrom. = E(</span><span class="si">{:1.1f}</span><span class="s1">,</span><span class="si">{:1.4f}</span><span class="s1">,</span><span class="si">{:1.4f}</span><span class="s1">)/T(not specified), &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Yxy_ests</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">Yxy_ests</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">Yxy_ests</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>    

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_fcn</span><span class="o">.</span><span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># create output_str for spdi and print:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_fcn</span><span class="o">.</span><span class="n">f</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj_fcn_vals</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="nb">tuple</span><span class="p">):</span>
                            <span class="n">obj_fcn_vals_ij</span> <span class="o">=</span> <span class="n">obj_fcn_vals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">obj_fcn_vals_ij</span> <span class="o">=</span> <span class="n">obj_fcn_vals</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">output_str</span> <span class="o">=</span> <span class="n">output_str</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj_fcn</span><span class="o">.</span><span class="n">_get_fj_output_str</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">obj_fcn_vals_ij</span><span class="p">,</span> <span class="n">F_ij</span> <span class="o">=</span>  <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">output_str</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    
        <span class="c1"># Take Root-Sum-of-Squares of delta((val - tar)**2):</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span><span class="o">.</span><span class="n">pareto</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_fcn</span><span class="o">.</span><span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
              <span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">F</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&lt;=</span><span class="mi">1</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F:&#39;</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
        
        <span class="c1"># store function values and spds, primss, M in attribute optim_results:     </span>
        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">obj_fcn</span><span class="o">.</span><span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">out</span> <span class="o">!=</span> <span class="s1">&#39;F&#39;</span><span class="p">)):</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">optim_results</span><span class="p">[</span><span class="s1">&#39;obj_fv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj_fcn_vals</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optim_results</span><span class="p">[</span><span class="s1">&#39;Yxy_est&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Yxy_ests</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">out</span> <span class="o">!=</span> <span class="s1">&#39;F&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optim_results</span><span class="p">[</span><span class="s1">&#39;spd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spds</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optim_results</span><span class="p">[</span><span class="s1">&#39;prims&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">primss</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optim_results</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ms</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optim_results</span><span class="p">[</span><span class="s1">&#39;x_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
            
        <span class="c1"># return requested output:</span>
        <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">F</span>
        <span class="k">elif</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;spds,primss,Ms&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spds</span><span class="p">,</span> <span class="n">primss</span><span class="p">,</span> <span class="n">Ms</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>   </div>
        
        
<div class="viewcode-block" id="SpectralOptimizer.start"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.SpectralOptimizer.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start optimization of _fitnessfcn for n primaries using the initialized minimizer and the selected optimizer_type.</span>
<span class="sd">        </span>
<span class="sd">        Returns variables specified in :out:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span>
        <span class="n">optim_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fitness_fcn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">npars</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;out&#39;</span><span class="p">:</span><span class="s1">&#39;F&#39;</span><span class="p">},</span> 
                                        <span class="bp">self</span><span class="o">.</span><span class="n">bnds</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">)</span>
    
        <span class="n">x_final</span> <span class="o">=</span> <span class="n">optim_results</span><span class="p">[</span><span class="s1">&#39;x_final&#39;</span><span class="p">]</span>
        <span class="n">spds</span><span class="p">,</span><span class="n">primss</span><span class="p">,</span><span class="n">Ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fitness_fcn</span><span class="p">(</span><span class="n">x_final</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;spds,primss,Ms&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span>
        <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;spds,primss,Ms,x_final,results&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spds</span><span class="p">,</span> <span class="n">primss</span><span class="p">,</span> <span class="n">Ms</span><span class="p">,</span> <span class="n">x_final</span><span class="p">,</span> <span class="n">optim_results</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div></div>

       
<div class="viewcode-block" id="spd_optimizer2"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.spdbuild.spd_optimizer2">[docs]</a><span class="k">def</span> <span class="nf">spd_optimizer2</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">np2d</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">]),</span> <span class="n">tar_type</span> <span class="o">=</span> <span class="s1">&#39;Yxy&#39;</span><span class="p">,</span> <span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="p">{},</span>
                  <span class="n">n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wlr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">360</span><span class="p">,</span><span class="mi">830</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">prims</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">cieobs</span> <span class="o">=</span> <span class="n">_CIEOBS</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;spds,primss,Ms,results&#39;</span><span class="p">,</span>
                  <span class="n">optimizer_type</span> <span class="o">=</span> <span class="s1">&#39;3mixer&#39;</span><span class="p">,</span>
                  <span class="n">prim_constructor</span> <span class="o">=</span> <span class="n">gaussian_prim_constructor</span><span class="p">,</span>
                  <span class="n">prim_constructor_parameter_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;peakwl&#39;</span><span class="p">,</span> <span class="s1">&#39;fwhm&#39;</span><span class="p">],</span> 
                  <span class="n">prim_constructor_parameter_defs</span> <span class="o">=</span> <span class="p">{},</span>
                  <span class="n">obj_fcn</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                  <span class="n">obj_fcn_pars</span> <span class="o">=</span> <span class="p">[{}],</span> 
                  <span class="n">obj_fcn_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                  <span class="n">obj_tar_vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                  <span class="n">obj_tar_tols</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                  <span class="n">decimals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">],</span> 
                  <span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">minimize_method</span> <span class="o">=</span> <span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">,</span> <span class="n">minimize_opts</span> <span class="o">=</span> <span class="p">{},</span>
                  <span class="n">x0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pareto</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">display</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    | Generate a spectrum with specified white point and optimized for certain objective </span>
<span class="sd">    | functions from a set of primary spectra or primary spectrum model parameters.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :target: </span>
<span class="sd">            | np2d([100,1/3,1/3]), optional</span>
<span class="sd">            | ndarray with Yxy chromaticity of target.</span>
<span class="sd">        :tar_type:</span>
<span class="sd">            | &#39;Yxy&#39; or str, optional</span>
<span class="sd">            | Specifies the input type in :target: (e.g. &#39;Yxy&#39; or &#39;cct&#39;)</span>
<span class="sd">        :cspace_bwtf:</span>
<span class="sd">            | {}, optional</span>
<span class="sd">            | Backward (cspace_to_xyz) transform parameters </span>
<span class="sd">            | (see colortf()) to go from :tar_type: to &#39;Yxy&#39;).</span>
<span class="sd">        :n:</span>
<span class="sd">            | 4, optional</span>
<span class="sd">            | Number of primaries in light mixture.</span>
<span class="sd">        :wl: </span>
<span class="sd">            | [360,830,1], optional</span>
<span class="sd">            | Wavelengths used in optimization when :prims: is not an</span>
<span class="sd">              ndarray with spectral data.</span>
<span class="sd">        :cieobs:</span>
<span class="sd">            | _CIEOBS, optional</span>
<span class="sd">            | CIE CMF set used to calculate chromaticity values, if not provided </span>
<span class="sd">            | in :Yxyi:.</span>
<span class="sd">        :optimizer_type:</span>
<span class="sd">            | &#39;3mixer&#39;,  optional</span>
<span class="sd">            | Specifies type of chromaticity optimization </span>
<span class="sd">            | For help on &#39;3mixer&#39; algorithm, see notes below.</span>
<span class="sd">        :prims:</span>
<span class="sd">            | ndarray of predefined primary spectra.</span>
<span class="sd">            | If None: they are built from optimization parameters using the </span>
<span class="sd">            | function in :prim_constructor:</span>
<span class="sd">        :prim_constructor:</span>
<span class="sd">            | function that constructs the primaries from the optimization parameters</span>
<span class="sd">            | Should have the form: </span>
<span class="sd">            |   ``prim_constructor(x, n, wl, prim_constructor_parameter_types, **prim_constructor_parameter_defs)``</span>
<span class="sd">        :prim_constructor_parameter_types:</span>
<span class="sd">            | gaussian_prim_parameter_types [&#39;peakwl&#39;, &#39;fwhm&#39;], optional</span>
<span class="sd">            | List with strings of the parameters used by prim_constructor() to</span>
<span class="sd">            | calculate the primary spd. All parameters listed and that do not</span>
<span class="sd">            | have default values (one for each prim!!!) in prim_constructor_parameters_defs </span>
<span class="sd">            | will be optimized.</span>
<span class="sd">        :prim_constructor_parameters_defs:</span>
<span class="sd">            | {}, optional</span>
<span class="sd">            | Dict with constructor parameters required by prim_constructor and/or </span>
<span class="sd">            | default values for parameters that are not being optimized.</span>
<span class="sd">            | For example: {&#39;fwhm&#39;:  30} will keep fwhm fixed and not optimize it.</span>
<span class="sd">        :obj_fcn: </span>
<span class="sd">            | [None] or list, optional</span>
<span class="sd">            | Function handles to objective function.</span>
<span class="sd">        :obj_fcn_weights:</span>
<span class="sd">            | [1] or list, optional.</span>
<span class="sd">            | Weigths for each obj. fcn</span>
<span class="sd">        :obj_fcn_pars:</span>
<span class="sd">            | [{}] or list, optional</span>
<span class="sd">            | Parameter dicts for each obj. fcn.</span>
<span class="sd">        :obj_tar_vals:</span>
<span class="sd">            | [0] or list, optional</span>
<span class="sd">            | Target values for each objective function.</span>
<span class="sd">        :obj_tar_tols:</span>
<span class="sd">            | [0] or list, optional</span>
<span class="sd">            | Tolerance of objective function values with target values.</span>
<span class="sd">        :decimals:</span>
<span class="sd">            | [5], optional</span>
<span class="sd">            | Rounding decimals of objective function values.</span>
<span class="sd">        :minimize_method:</span>
<span class="sd">            | &#39;Nelder-Mead&#39;, optional</span>
<span class="sd">            | Optimization method used by minimize function.</span>
<span class="sd">            | options: </span>
<span class="sd">            |   - &#39;Nelder-Mead&#39;: Nelder-Mead simplex local optimization </span>
<span class="sd">            |                    using the luxpy.math.minimizebnd wrapper</span>
<span class="sd">            |                    with method set to &#39;Nelder-Mead&#39;.</span>
<span class="sd">            |   - &#39;demo&#39; :  Differential Evolutionary Multiobjective Optimizatizer</span>
<span class="sd">            |               (using math.DEMO.demo_opt)</span>
<span class="sd">            |   - &#39;particleswarm&#39;: Pseudo-global optimizer using particle swarms</span>
<span class="sd">            |                      (from pyswarm wrapper module luxpy.math.pyswarms_particleswarm)</span>
<span class="sd">            |   - &#39;nsga_ii&#39;: Pareto multiobjective optimizer using the NSGA-II genetic algorithm</span>
<span class="sd">            |                      (from pymoo wrapper module luxpy.math.pymoo_nsga_ii)</span>
<span class="sd">            |   - A user-defined minimization function (see _start_optimization_tri? for </span>
<span class="sd">            |       info on the requirements of this function)</span>
<span class="sd">        :minimize_opts:</span>
<span class="sd">            | None, optional</span>
<span class="sd">            | Dict with minimization options. </span>
<span class="sd">            | None defaults to the options depending on choice of minimize_method</span>
<span class="sd">            |  - &#39;Nelder-Mead&#39;   : {&#39;xtol&#39;: 1e-5, &#39;disp&#39;: True, &#39;maxiter&#39;: 1000*Nc,</span>
<span class="sd">            |                       &#39;maxfev&#39; : 1000*Nc,&#39;fatol&#39;: 0.01}</span>
<span class="sd">            |  - &#39;demo&#39; :          {&#39;F&#39;: 0.5, &#39;CR&#39;: 0.3, &#39;kmax&#39;: 300, &#39;mu&#39;: 100, &#39;display&#39;: True}</span>
<span class="sd">            |  - &#39;particleswarm&#39; : {&#39;iters&#39;: 100, &#39;n_particles&#39;: 10, &#39;ftol&#39;: -np.inf,</span>
<span class="sd">            |                       &#39;ps_opts&#39; : {&#39;c1&#39;: 0.5, &#39;c2&#39;: 0.3, &#39;w&#39;:0.9}}</span>
<span class="sd">            |  - &#39;nsga_ii&#39; : {&#39;n_gen&#39; : 40, &#39;n_pop&#39; : 400, &#39;n_offsprings&#39; : None,</span>
<span class="sd">            |                 &#39;termination&#39; : (&#39;n_gen&#39; , 40), &#39;seed&#39; : 1,</span>
<span class="sd">            |                 &#39;ga_opts&#39; : {&#39;sampling&#39;  : (&quot;real_random&quot;,{}),</span>
<span class="sd">            |                              &#39;crossover&#39; : (&quot;real_sbx&quot;, {&#39;prob&#39; : 0.9, &#39;eta&#39; : 15}),</span>
<span class="sd">            |                              &#39;mutation&#39;  : (&quot;real_pm&quot;,  {&#39;eta&#39; : 20})}}</span>
<span class="sd">            |  - dict with options for user-defined minimization method.</span>
<span class="sd">        :triangle_strength_bnds:</span>
<span class="sd">            | (None,None)</span>
<span class="sd">            | Specifies lower- and upper-bounds for the strengths of each of the primary</span>
<span class="sd">            | combinations that will be made during the optimization using &#39;3mixer&#39;.</span>
<span class="sd">        :x0:</span>
<span class="sd">            | None, optional</span>
<span class="sd">            | If None: a random starting value will be generated for the Nelder-Mead</span>
<span class="sd">            | minimization algorithm, else the user defined starting value will be used.</span>
<span class="sd">            | Note that it should only contain a value for each peakwl and/or fwhm that</span>
<span class="sd">            | is set to be optimized. The triangle_strengths are added automatically.</span>
<span class="sd">        :pareto:</span>
<span class="sd">            | False, optional</span>
<span class="sd">            | Specifies whether the output of the fitnessfcn should be the Root-Sum-of-Squares </span>
<span class="sd">            | of all weighted objective function values or not. Individual function values are</span>
<span class="sd">            | required by true multi-objective optimizers (i.e. pareto == True).</span>
<span class="sd">        :display:</span>
<span class="sd">            | True, optional</span>
<span class="sd">            | Turn native display options of minimizers on (True) or off (False).</span>

<span class="sd">        :verbosity:</span>
<span class="sd">            | 0, optional</span>
<span class="sd">            | If &gt; 0: print intermediate results.</span>
<span class="sd">        :out:</span>
<span class="sd">            | &#39;spds,primss,Ms,results&#39;, optional</span>
<span class="sd">            | Determines output of function (see :returns:).</span>
<span class="sd">            </span>
<span class="sd">    Returns:</span>
<span class="sd">        :returns: </span>
<span class="sd">            | spds, primss,Ms,results</span>
<span class="sd">            | - &#39;spds&#39;: optimized spectrum (or spectra: for demo, particleswarm and nsga_ii minimization methods)</span>
<span class="sd">            | - &#39;primss&#39;: primary spectra of each optimized spectrum</span>
<span class="sd">            | - &#39;Ms&#39; : ndarrays with fluxes of each primary</span>
<span class="sd">            | - &#39;results&#39;: dict with optimization results</span>

<span class="sd">    Notes on the optimization algorithms:</span>
<span class="sd">        </span>
<span class="sd">        1. &#39;3mixer&#39;: The triangle/trio method creates for all possible </span>
<span class="sd">        combinations of 3 primary component spectra a spectrum that results in </span>
<span class="sd">        the target chromaticity using color3mixer() and then optimizes the </span>
<span class="sd">        weights of each of the latter spectra such that adding them </span>
<span class="sd">        (additive mixing) results in obj_vals as close as possible to the </span>
<span class="sd">        target values.</span>
<span class="sd">       </span>
<span class="sd">        2. &#39;2mixer&#39;: APRIL 2020, NOT YET IMPLEMENTED!!</span>
<span class="sd">        Pairs (odd,even) of components are selected and combined using </span>
<span class="sd">        &#39;pair_strength&#39;. This process is continued until only 3 (combined)</span>
<span class="sd">        intermediate sources remain. Color3mixer is then used to calculate </span>
<span class="sd">        the fluxes for the remaining 3 sources, after which the fluxes of </span>
<span class="sd">        all components are back-calculated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">so</span> <span class="o">=</span> <span class="n">SpectralOptimizer</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">,</span> <span class="n">tar_type</span> <span class="o">=</span> <span class="n">tar_type</span><span class="p">,</span> <span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="n">cspace_bwtf</span><span class="p">,</span>
                            <span class="n">nprim</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">wlr</span> <span class="o">=</span> <span class="n">wlr</span><span class="p">,</span> <span class="n">cieobs</span> <span class="o">=</span> <span class="n">cieobs</span><span class="p">,</span> 
                            <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;spds,primss,Ms,results&#39;</span><span class="p">,</span>
                            <span class="n">optimizer_type</span> <span class="o">=</span> <span class="n">optimizer_type</span><span class="p">,</span>
                            <span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="n">triangle_strengths_bnds</span><span class="p">,</span>
                            <span class="n">prim_constructor</span> <span class="o">=</span> <span class="n">PrimConstructor</span><span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="n">prim_constructor</span><span class="p">,</span> 
                                                               <span class="n">ptypes</span> <span class="o">=</span> <span class="n">prim_constructor_parameter_types</span><span class="p">,</span>
                                                               <span class="n">pdefs</span> <span class="o">=</span> <span class="n">prim_constructor_parameter_defs</span><span class="p">),</span> 
                            <span class="n">prims</span> <span class="o">=</span> <span class="n">prims</span><span class="p">,</span>
                            <span class="n">obj_fcn</span> <span class="o">=</span> <span class="n">ObjFcns</span><span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="n">obj_fcn</span><span class="p">,</span>
                                              <span class="n">fp</span> <span class="o">=</span> <span class="n">obj_fcn_pars</span><span class="p">,</span>
                                              <span class="n">fw</span> <span class="o">=</span> <span class="n">obj_fcn_weights</span><span class="p">,</span>
                                              <span class="n">ft</span> <span class="o">=</span> <span class="n">obj_tar_vals</span><span class="p">,</span>
                                              <span class="n">ft_tol</span> <span class="o">=</span> <span class="n">obj_tar_tols</span><span class="p">,</span>
                                              <span class="n">decimals</span> <span class="o">=</span> <span class="n">decimals</span><span class="p">),</span>
                            <span class="n">minimizer</span> <span class="o">=</span> <span class="n">Minimizer</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="n">minimize_method</span><span class="p">,</span>
                                                  <span class="n">opts</span> <span class="o">=</span> <span class="n">minimize_opts</span><span class="p">,</span>
                                                  <span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span><span class="p">,</span>
                                                  <span class="n">pareto</span> <span class="o">=</span> <span class="n">pareto</span><span class="p">,</span>
                                                  <span class="n">display</span> <span class="o">=</span> <span class="n">display</span><span class="p">),</span>
                            <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>
    <span class="c1"># start optimization:</span>
    <span class="k">return</span> <span class="n">so</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="p">)</span></div>

      
  <span class="c1">#------------------------------------------------------------------------------</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>  
    
    
    <span class="n">run_example_class_1</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># # class based example with pre-defined minimization methods</span>
    
    <span class="n">run_example_class_2</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># # class based example with pre-defined minimization methods and primary set</span>

    <span class="n">run_example_class_3</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># # class based example with user-defined  minimization method   </span>

    <span class="n">run_example_class_4</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># # class based example with pre-defined primaries and demo minimization</span>

    <span class="n">run_example_class_5</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># # class based example with pre-defined primaries and demo minimization with obj_fcn using &#39;solution_info&#39; to steer the optimization to solutions with the max number of channels &#39;on&#39;</span>
    
    <span class="n">run_example_fcn_1</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># function based example: use pre-defined minimization methods (spd_optimize2())</span>

    <span class="n">run_example_fcn_2</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># function based example: use user-defined  minimization method (spd_optimizer2()) </span>
    
    
    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="kn">import</span> <span class="nn">luxpy</span> <span class="k">as</span> <span class="nn">lx</span>
    <span class="n">cieobs</span> <span class="o">=</span> <span class="s1">&#39;1964_10&#39;</span>
    
    
    <span class="c1"># define function that calculates several objectives at the same time (for speed):</span>
    <span class="k">def</span> <span class="nf">spd_to_cris</span><span class="p">(</span><span class="n">spd</span><span class="p">):</span>
        <span class="n">Rf</span><span class="p">,</span><span class="n">Rg</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">cri</span><span class="o">.</span><span class="n">spd_to_cri</span><span class="p">(</span><span class="n">spd</span><span class="p">,</span> <span class="n">cri_type</span><span class="o">=</span><span class="s1">&#39;ies-tm30&#39;</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="s1">&#39;Rf,Rg&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Rf</span><span class="p">,</span> <span class="n">Rg</span><span class="p">))</span>   
    
    <span class="k">def</span> <span class="nf">spd_to_cct</span><span class="p">(</span><span class="n">spd</span><span class="p">):</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">spd_to_xyz</span><span class="p">(</span><span class="n">spd</span><span class="p">,</span><span class="n">cieobs</span><span class="o">=</span><span class="n">cieobs</span><span class="p">)</span>
        <span class="n">cct</span><span class="p">,</span> <span class="n">duv</span> <span class="o">=</span> <span class="n">xyz_to_cct</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">cieobs</span><span class="o">=</span><span class="n">cieobs</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="s1">&#39;cct,duv&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cct</span><span class="p">)</span> <span class="c1"># out-of-lut ccts are encoded as negative</span>
        <span class="k">return</span> <span class="n">cct</span><span class="p">,</span> <span class="n">duv</span>
    
    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">if</span> <span class="n">run_example_class_1</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        
        <span class="n">so1</span> <span class="o">=</span> <span class="n">SpectralOptimizer</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">np2d</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">]),</span> <span class="n">tar_type</span> <span class="o">=</span> <span class="s1">&#39;Yxy&#39;</span><span class="p">,</span> <span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="p">{},</span>
                              <span class="n">nprim</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wlr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">360</span><span class="p">,</span><span class="mi">830</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">cieobs</span> <span class="o">=</span> <span class="n">cieobs</span><span class="p">,</span> 
                              <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;spds,primss,Ms,results&#39;</span><span class="p">,</span>
                              <span class="n">optimizer_type</span> <span class="o">=</span> <span class="s1">&#39;3mixer&#39;</span><span class="p">,</span> <span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">prim_constructor</span> <span class="o">=</span> <span class="n">PrimConstructor</span><span class="p">(</span><span class="n">pdefs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fwhm&#39;</span><span class="p">:[</span><span class="mi">15</span><span class="p">],</span>
                                                                        <span class="s1">&#39;peakwl_bnds&#39;</span><span class="p">:[</span><span class="mi">400</span><span class="p">,</span><span class="mi">700</span><span class="p">],</span>
                                                                        <span class="s1">&#39;fwhm_bnds&#39;</span><span class="p">:[</span><span class="mi">5</span><span class="p">,</span><span class="mi">300</span><span class="p">]}),</span> 
                              <span class="n">prims</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">obj_fcn</span> <span class="o">=</span> <span class="n">ObjFcns</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="p">[(</span><span class="n">spd_to_cris</span><span class="p">,</span><span class="s1">&#39;Rf&#39;</span><span class="p">,</span><span class="s1">&#39;Rg&#39;</span><span class="p">)],</span> <span class="n">ft</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">90</span><span class="p">,</span><span class="mi">110</span><span class="p">)],</span> <span class="n">ft_tol</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)]),</span>
                              <span class="n">minimizer</span> <span class="o">=</span> <span class="n">Minimizer</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">),</span>
                              <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># start optimization:</span>
        <span class="n">spd</span><span class="p">,</span><span class="n">M</span> <span class="o">=</span> <span class="n">so1</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;spds,Ms&#39;</span><span class="p">)</span>
        
        <span class="n">Rf</span><span class="p">,</span> <span class="n">Rg</span> <span class="o">=</span> <span class="n">spd_to_cris</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obj_fcn1:&#39;</span><span class="p">,</span><span class="n">Rf</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obj_fcn2:&#39;</span><span class="p">,</span><span class="n">Rg</span><span class="p">)</span>
        
    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">if</span> <span class="n">run_example_class_2</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        
        <span class="c1"># create set of 4 primaries with fixed fwhm at 15 nm:</span>
        <span class="n">prims</span> <span class="o">=</span> <span class="n">PrimConstructor</span><span class="p">(</span><span class="n">pdefs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;peakwl&#39;</span><span class="p">:[</span><span class="mi">450</span><span class="p">,</span><span class="mi">520</span><span class="p">,</span><span class="mi">580</span><span class="p">,</span><span class="mi">630</span><span class="p">],</span><span class="s1">&#39;fwhm&#39;</span><span class="p">:[</span><span class="mi">15</span><span class="p">],</span>
                                        <span class="s1">&#39;peakwl_bnds&#39;</span><span class="p">:[</span><span class="mi">400</span><span class="p">,</span><span class="mi">700</span><span class="p">],</span>
                                        <span class="s1">&#39;fwhm_bnds&#39;</span><span class="p">:[</span><span class="mi">5</span><span class="p">,</span><span class="mi">300</span><span class="p">]})</span><span class="o">.</span><span class="n">get_spd</span><span class="p">()</span>
                    
        <span class="c1"># create set of 4 primaries with fixed peakwl and fwhm bounds set to [5,300]:</span>
        <span class="n">prims2</span> <span class="o">=</span> <span class="n">PrimConstructor</span><span class="p">(</span><span class="n">pdefs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;peakwl&#39;</span><span class="p">:[</span><span class="mi">450</span><span class="p">,</span><span class="mi">520</span><span class="p">,</span><span class="mi">580</span><span class="p">,</span><span class="mi">630</span><span class="p">],</span>
                                        <span class="s1">&#39;fwhm_bnds&#39;</span><span class="p">:[</span><span class="mi">5</span><span class="p">,</span><span class="mi">300</span><span class="p">]})</span><span class="o">.</span><span class="n">get_spd</span><span class="p">()</span>
                    
        <span class="c1"># create set of 4 primaries with free peakwl and fwhm bounds set to [400,700] and [5,300]:</span>
        <span class="n">prims3</span> <span class="o">=</span> <span class="n">PrimConstructor</span><span class="p">(</span><span class="n">pdefs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;peakwl_bnds&#39;</span><span class="p">:[</span><span class="mi">400</span><span class="p">,</span><span class="mi">700</span><span class="p">],</span>
                                        <span class="s1">&#39;fwhm_bnds&#39;</span><span class="p">:[</span><span class="mi">5</span><span class="p">,</span><span class="mi">300</span><span class="p">]})</span><span class="o">.</span><span class="n">get_spd</span><span class="p">(</span><span class="n">nprim</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        
        <span class="n">so2</span> <span class="o">=</span> <span class="n">SpectralOptimizer</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">np2d</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">]),</span> <span class="n">tar_type</span> <span class="o">=</span> <span class="s1">&#39;Yxy&#39;</span><span class="p">,</span> <span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="p">{},</span>
                              <span class="n">wlr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">360</span><span class="p">,</span><span class="mi">830</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">cieobs</span> <span class="o">=</span> <span class="n">cieobs</span><span class="p">,</span> 
                              <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;spds,primss,Ms,results&#39;</span><span class="p">,</span>
                              <span class="n">optimizer_type</span> <span class="o">=</span> <span class="s1">&#39;3mixer&#39;</span><span class="p">,</span> <span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">prim_constructor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                              <span class="n">prims</span> <span class="o">=</span> <span class="n">prims</span><span class="p">,</span>
                              <span class="n">obj_fcn</span> <span class="o">=</span> <span class="n">ObjFcns</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="p">[(</span><span class="n">spd_to_cris</span><span class="p">,</span><span class="s1">&#39;Rf&#39;</span><span class="p">,</span><span class="s1">&#39;Rg&#39;</span><span class="p">)],</span> <span class="n">ft</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">90</span><span class="p">,</span><span class="mi">110</span><span class="p">)]),</span>
                              <span class="n">minimizer</span> <span class="o">=</span> <span class="n">Minimizer</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">),</span>
                              <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<span class="c1">#        # start optimization:</span>
        <span class="n">spd</span><span class="p">,</span><span class="n">M</span> <span class="o">=</span> <span class="n">so2</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;spds,Ms&#39;</span><span class="p">)</span>
        
        <span class="n">Rf</span><span class="p">,</span> <span class="n">Rg</span> <span class="o">=</span> <span class="n">spd_to_cris</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obj_fcn1:&#39;</span><span class="p">,</span><span class="n">Rf</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obj_fcn2:&#39;</span><span class="p">,</span><span class="n">Rg</span><span class="p">)</span>

    
    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">if</span> <span class="n">run_example_class_3</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        
        
        <span class="k">def</span> <span class="nf">user_prim_constructor4</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nprims</span><span class="p">,</span> <span class="n">wlr</span><span class="p">,</span> 
                              <span class="n">ptypes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;peakwl&#39;</span><span class="p">,</span><span class="s1">&#39;spectral_width&#39;</span><span class="p">],</span> 
                              <span class="o">**</span><span class="n">pdefs</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            User defined prim constructor: lorenztian 2e order profile.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Extract the primary parameters from x and prim_constructor_parameter_defs:</span>
            <span class="n">pars</span> <span class="o">=</span> <span class="n">_extract_prim_optimization_parameters</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nprims</span><span class="p">,</span> <span class="n">ptypes</span><span class="p">,</span> <span class="n">pdefs</span><span class="p">)</span>
            <span class="c1"># setup wavelengths:</span>
            <span class="n">wlr</span> <span class="o">=</span> <span class="n">_setup_wlr</span><span class="p">(</span><span class="n">wlr</span><span class="p">)</span>
            
            <span class="c1"># Collect parameters from pars dict:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mf">0.5</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
            <span class="n">spd</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;peakwl&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">wlr</span><span class="p">)</span><span class="o">/</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;spectral_width&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
            
            <span class="c1"># stack wavelengths and spd:</span>
            <span class="k">return</span> <span class="n">_stack_wlr_spd</span><span class="p">(</span><span class="n">wlr</span><span class="p">,</span> <span class="n">spd</span><span class="p">)</span>
        
        
        <span class="c1"># Create a minimization function with the specified interface:</span>
        <span class="kn">from</span> <span class="nn">luxpy.math.pyswarms_particleswarm</span> <span class="kn">import</span> <span class="n">particleswarm</span>
        <span class="k">def</span> <span class="nf">user_minim_ps</span><span class="p">(</span><span class="n">fitnessfcn</span><span class="p">,</span> <span class="n">npars</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="o">**</span><span class="n">opts</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">particleswarm</span><span class="p">(</span><span class="n">fitnessfcn</span><span class="p">,</span> <span class="n">npars</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">,</span> 
                                          <span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">,</span> 
                                          <span class="n">iters</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">n_particles</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">ftol</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                                          <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;c1&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span><span class="mf">0.9</span><span class="p">},</span>
                                          <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>
            <span class="c1"># Note that there is already a key &#39;x_final&#39; in results</span>
            <span class="k">return</span> <span class="n">results</span>
        
        <span class="kn">from</span> <span class="nn">luxpy.math.pymoo_nsga_ii</span> <span class="kn">import</span> <span class="n">nsga_ii</span>
        <span class="k">def</span> <span class="nf">user_minim_ga</span><span class="p">(</span><span class="n">fitnessfcn</span><span class="p">,</span> <span class="n">npars</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="o">**</span><span class="n">opts</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">nsga_ii</span><span class="p">(</span><span class="n">fitnessfcn</span><span class="p">,</span> <span class="n">npars</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">,</span> 
                              <span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">n_objectives</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">n_gen</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="n">n_pop</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">n_offspring</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>
            <span class="c1"># Note that there is already a key &#39;x_final&#39; in results</span>
            <span class="k">return</span> <span class="n">results</span>
        
        <span class="n">minimizer_nm</span> <span class="o">=</span> <span class="n">Minimizer</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">,</span><span class="n">pareto</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">minimizer_ps</span> <span class="o">=</span> <span class="n">Minimizer</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">user_minim_ps</span><span class="p">,</span><span class="n">pareto</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">minimizer_ga</span> <span class="o">=</span> <span class="n">Minimizer</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">user_minim_ga</span><span class="p">,</span><span class="n">pareto</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        
        <span class="n">so3</span> <span class="o">=</span> <span class="n">SpectralOptimizer</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">np2d</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">]),</span> <span class="n">tar_type</span> <span class="o">=</span> <span class="s1">&#39;Yxy&#39;</span><span class="p">,</span> <span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="p">{},</span>
                              <span class="n">nprim</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wlr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">360</span><span class="p">,</span><span class="mi">830</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">cieobs</span> <span class="o">=</span> <span class="n">cieobs</span><span class="p">,</span> 
                              <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;spds,primss,Ms,results&#39;</span><span class="p">,</span>
                              <span class="n">optimizer_type</span> <span class="o">=</span> <span class="s1">&#39;3mixer&#39;</span><span class="p">,</span> <span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">prim_constructor</span> <span class="o">=</span> <span class="n">PrimConstructor</span><span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="n">user_prim_constructor4</span><span class="p">,</span> 
                                                                  <span class="n">ptypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;peakwl&#39;</span><span class="p">,</span><span class="s1">&#39;spectral_width&#39;</span><span class="p">],</span>
                                                                  <span class="n">pdefs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;peakwl_bnds&#39;</span><span class="p">:[</span><span class="mi">400</span><span class="p">,</span><span class="mi">700</span><span class="p">],</span>
                                                                          <span class="s1">&#39;spectral_width_bnds&#39;</span><span class="p">:[</span><span class="mi">5</span><span class="p">,</span><span class="mi">300</span><span class="p">]}),</span> 
                              <span class="n">prims</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">obj_fcn</span> <span class="o">=</span> <span class="n">ObjFcns</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="p">[(</span><span class="n">spd_to_cris</span><span class="p">,</span><span class="s1">&#39;Rf&#39;</span><span class="p">,</span><span class="s1">&#39;Rg&#39;</span><span class="p">)],</span> <span class="n">ft</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">90</span><span class="p">,</span><span class="mi">110</span><span class="p">)]),</span>
                              <span class="n">minimizer</span> <span class="o">=</span> <span class="n">minimizer_ps</span><span class="p">,</span>
                              <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># start optimization:</span>
        <span class="n">spd</span><span class="p">,</span><span class="n">M</span> <span class="o">=</span> <span class="n">so3</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;spds,Ms&#39;</span><span class="p">)</span>
        
        <span class="n">Rf</span><span class="p">,</span> <span class="n">Rg</span> <span class="o">=</span> <span class="n">spd_to_cris</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obj_fcn1:&#39;</span><span class="p">,</span><span class="n">Rf</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obj_fcn2:&#39;</span><span class="p">,</span><span class="n">Rg</span><span class="p">)</span>
        
        
    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">if</span> <span class="n">run_example_class_4</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        
        <span class="c1"># create set of 4 primaries with fixed peakwl and fwhm bounds set to [5,300]:</span>
        <span class="n">prims</span> <span class="o">=</span> <span class="n">PrimConstructor</span><span class="p">(</span><span class="n">pdefs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;peakwl&#39;</span><span class="p">:[</span><span class="mi">450</span><span class="p">,</span><span class="mi">520</span><span class="p">,</span><span class="mi">580</span><span class="p">,</span><span class="mi">630</span><span class="p">],</span><span class="s1">&#39;fwhm&#39;</span><span class="p">:[</span><span class="mi">15</span><span class="p">],</span>
                                        <span class="s1">&#39;peakwl_bnds&#39;</span><span class="p">:[</span><span class="mi">400</span><span class="p">,</span><span class="mi">700</span><span class="p">],</span>
                                        <span class="s1">&#39;fwhm_bnds&#39;</span><span class="p">:[</span><span class="mi">5</span><span class="p">,</span><span class="mi">300</span><span class="p">]})</span><span class="o">.</span><span class="n">get_spd</span><span class="p">()</span>
        
        <span class="c1"># create set of 4 primaries with fixed peakwl and fwhm bounds set to [5,300]:</span>
        <span class="n">prims2</span> <span class="o">=</span> <span class="n">PrimConstructor</span><span class="p">(</span><span class="n">pdefs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;peakwl&#39;</span><span class="p">:[</span><span class="mi">450</span><span class="p">,</span><span class="mi">520</span><span class="p">,</span><span class="mi">580</span><span class="p">,</span><span class="mi">630</span><span class="p">],</span>
                                        <span class="s1">&#39;fwhm_bnds&#39;</span><span class="p">:[</span><span class="mi">5</span><span class="p">,</span><span class="mi">300</span><span class="p">]})</span><span class="o">.</span><span class="n">get_spd</span><span class="p">()</span>

        <span class="n">so4</span> <span class="o">=</span> <span class="n">SpectralOptimizer</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">np2d</span><span class="p">([</span><span class="mi">50</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">]),</span> <span class="n">tar_type</span> <span class="o">=</span> <span class="s1">&#39;Yxy&#39;</span><span class="p">,</span> <span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="p">{},</span>
                              <span class="n">wlr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">360</span><span class="p">,</span><span class="mi">830</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">cieobs</span> <span class="o">=</span> <span class="n">cieobs</span><span class="p">,</span> 
                              <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;spds,primss,Ms,results&#39;</span><span class="p">,</span>
                              <span class="n">optimizer_type</span> <span class="o">=</span> <span class="s1">&#39;3mixer&#39;</span><span class="p">,</span> <span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">prim_constructor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                              <span class="n">prims</span> <span class="o">=</span> <span class="n">prims2</span><span class="p">,</span>
                              <span class="n">obj_fcn</span> <span class="o">=</span> <span class="n">ObjFcns</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="p">[(</span><span class="n">spd_to_cris</span><span class="p">,</span><span class="s1">&#39;Rf&#39;</span><span class="p">,</span><span class="s1">&#39;Rg&#39;</span><span class="p">)],</span> 
                                                <span class="n">ft</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">90</span><span class="p">,</span><span class="mi">110</span><span class="p">)]),</span>
                              <span class="n">minimizer</span> <span class="o">=</span> <span class="n">Minimizer</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ps&#39;</span><span class="p">,</span>
                                                    <span class="n">opts</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;iters&#39;</span><span class="p">:</span><span class="mi">50</span><span class="p">}),</span>
                              <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># start optimization:</span>
        <span class="n">spd</span><span class="p">,</span><span class="n">M</span> <span class="o">=</span> <span class="n">so4</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;spds,Ms&#39;</span><span class="p">)</span>
        
        <span class="n">Rf</span><span class="p">,</span> <span class="n">Rg</span> <span class="o">=</span> <span class="n">spd_to_cris</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obj_fcn1:&#39;</span><span class="p">,</span><span class="n">Rf</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obj_fcn2:&#39;</span><span class="p">,</span><span class="n">Rg</span><span class="p">)</span>
        
        <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">if</span> <span class="n">run_example_class_5</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        
        <span class="c1"># define user obj functions that asks for solutions info to use</span>
        <span class="c1"># when determining function output. For example, to give very &#39;bad&#39;</span>
        <span class="c1"># Rf,Rg values (forcing the optimization away from this type of solutions)</span>
        <span class="c1"># when the number of channels with a relative weight smaller than 10%</span>
        <span class="c1"># is larger than 1 (in other words, try and force te search towards</span>
        <span class="c1"># solutins that have all channels sufficiently &#39;on&#39;):</span>
        <span class="k">def</span> <span class="nf">spd_to_cris_with_solution_info</span><span class="p">(</span><span class="n">spd</span><span class="p">,</span> <span class="n">solution_info</span> <span class="o">=</span> <span class="p">{}):</span>
            <span class="n">Ms</span> <span class="o">=</span> <span class="n">solution_info</span><span class="p">[</span><span class="s1">&#39;Ms&#39;</span><span class="p">]</span>
            <span class="n">Ms</span> <span class="o">=</span> <span class="n">Ms</span><span class="o">/</span><span class="n">Ms</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># normalize to max</span>
            <span class="n">good_solutions</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ms</span> <span class="o">&gt;=</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">Ms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">spd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">good_solutions</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">good_solutions</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="mi">30</span> <span class="c1"># higher number of on-channels is better (just setting zeros no matter how many bad channels makes it more difficult to optimize, same as setting a really really low value like -1000)</span>
            <span class="k">if</span> <span class="n">good_solutions</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">spds_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">spd</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span><span class="n">spd</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">good_solutions</span><span class="p">]))</span> <span class="c1"># only good solutions need calculating</span>
                <span class="n">Rf</span><span class="p">,</span><span class="n">Rg</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">cri</span><span class="o">.</span><span class="n">spd_to_cri</span><span class="p">(</span><span class="n">spds_good</span><span class="p">,</span> <span class="n">cri_type</span><span class="o">=</span><span class="s1">&#39;ies-tm30&#39;</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="s1">&#39;Rf,Rg&#39;</span><span class="p">)</span>
                <span class="n">RfRg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Rf</span><span class="p">,</span> <span class="n">Rg</span><span class="p">))</span>
                <span class="n">out</span><span class="p">[:,</span><span class="n">good_solutions</span><span class="p">]</span> <span class="o">=</span> <span class="n">RfRg</span> 
            <span class="k">return</span> <span class="n">out</span>
              
        <span class="c1"># create set of 4 primaries with fixed peakwl and fwhm bounds set to [5,300]:</span>
        <span class="n">prims</span> <span class="o">=</span> <span class="n">PrimConstructor</span><span class="p">(</span><span class="n">pdefs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;peakwl&#39;</span><span class="p">:[</span><span class="mi">450</span><span class="p">,</span><span class="mi">470</span><span class="p">,</span><span class="mi">500</span><span class="p">,</span><span class="mi">520</span><span class="p">,</span><span class="mi">560</span><span class="p">,</span><span class="mi">580</span><span class="p">,</span><span class="mi">630</span><span class="p">],</span>
                                        <span class="s1">&#39;fwhm_bnds&#39;</span><span class="p">:[</span><span class="mi">5</span><span class="p">,</span><span class="mi">300</span><span class="p">]})</span><span class="o">.</span><span class="n">get_spd</span><span class="p">()</span>

        <span class="n">so4</span> <span class="o">=</span> <span class="n">SpectralOptimizer</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">np2d</span><span class="p">([</span><span class="mi">50</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">]),</span> <span class="n">tar_type</span> <span class="o">=</span> <span class="s1">&#39;Yxy&#39;</span><span class="p">,</span> <span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="p">{},</span>
                              <span class="n">wlr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">360</span><span class="p">,</span><span class="mi">830</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">cieobs</span> <span class="o">=</span> <span class="n">cieobs</span><span class="p">,</span> 
                              <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;spds,primss,Ms,results&#39;</span><span class="p">,</span>
                              <span class="n">optimizer_type</span> <span class="o">=</span> <span class="s1">&#39;3mixer&#39;</span><span class="p">,</span> <span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">prim_constructor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                              <span class="n">prims</span> <span class="o">=</span> <span class="n">prims</span><span class="p">,</span>
                              <span class="n">obj_fcn</span> <span class="o">=</span> <span class="n">ObjFcns</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="p">[(</span><span class="n">spd_to_cris_with_solution_info</span><span class="p">,</span><span class="s1">&#39;Rf&#39;</span><span class="p">,</span><span class="s1">&#39;Rg&#39;</span><span class="p">)],</span> 
                                                <span class="n">ft</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">90</span><span class="p">,</span><span class="mi">110</span><span class="p">)],</span>
                                                <span class="n">f_requires_solution_info</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">]),</span>
                              <span class="n">minimizer</span> <span class="o">=</span> <span class="n">Minimizer</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ps&#39;</span><span class="p">,</span>
                                                    <span class="n">opts</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;iters&#39;</span><span class="p">:</span><span class="mi">50</span><span class="p">}),</span>
                              <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># start optimization:</span>
        <span class="n">spd</span><span class="p">,</span><span class="n">M</span> <span class="o">=</span> <span class="n">so4</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;spds,Ms&#39;</span><span class="p">)</span>
        
        <span class="n">Rf</span><span class="p">,</span> <span class="n">Rg</span> <span class="o">=</span> <span class="n">spd_to_cris</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obj_fcn1:&#39;</span><span class="p">,</span><span class="n">Rf</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obj_fcn2:&#39;</span><span class="p">,</span><span class="n">Rg</span><span class="p">)</span>
        
        <span class="c1"># check grahically:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">spd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;optimized spd (Rf=</span><span class="si">{:1.0f}</span><span class="s1">,Rg=</span><span class="si">{:1.0f}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Rf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Rg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">lx</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">Mi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Mi</span><span class="o">*</span><span class="n">prims</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;channel </span><span class="si">{:1.0f}</span><span class="s1"> (rel. flux = </span><span class="si">{:1.3f}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">Mi</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="c1">#--------------------------------------------------------------------------</span>
    <span class="k">if</span> <span class="n">run_example_fcn_1</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>

        <span class="c1"># start optimization:</span>
        <span class="n">spd</span><span class="p">,</span> <span class="n">prims</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">spd_optimizer2</span><span class="p">(</span><span class="n">np2d</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">]),</span> <span class="n">tar_type</span> <span class="o">=</span> <span class="s1">&#39;Yxy&#39;</span><span class="p">,</span> <span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="p">{},</span>
                                      <span class="n">n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wlr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">360</span><span class="p">,</span><span class="mi">830</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">prims</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                      <span class="n">cieobs</span> <span class="o">=</span> <span class="n">cieobs</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;spds,primss,Ms&#39;</span><span class="p">,</span> 
                                      <span class="n">prim_constructor</span> <span class="o">=</span> <span class="n">gaussian_prim_constructor</span><span class="p">,</span>
                                      <span class="n">prim_constructor_parameter_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;peakwl&#39;</span><span class="p">,</span> <span class="s1">&#39;fwhm&#39;</span><span class="p">],</span> 
                                      <span class="n">prim_constructor_parameter_defs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;peakwl_bnds&#39;</span><span class="p">:[</span><span class="mi">400</span><span class="p">,</span><span class="mi">700</span><span class="p">],</span>
                                                                         <span class="s1">&#39;fwhm_bnds&#39;</span><span class="p">:[</span><span class="mi">5</span><span class="p">,</span><span class="mi">300</span><span class="p">]},</span>
                                      <span class="n">obj_fcn</span> <span class="o">=</span> <span class="p">[(</span><span class="n">spd_to_cris</span><span class="p">,</span><span class="s1">&#39;Rf&#39;</span><span class="p">,</span><span class="s1">&#39;Rg&#39;</span><span class="p">)],</span> 
                                      <span class="n">obj_fcn_pars</span> <span class="o">=</span> <span class="p">[{}],</span> 
                                      <span class="n">obj_fcn_weights</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)],</span> 
                                      <span class="n">obj_tar_vals</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">90</span><span class="p">,</span><span class="mi">110</span><span class="p">)],</span>
                                      <span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                      <span class="n">minimize_method</span> <span class="o">=</span> <span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">,</span>
                                      <span class="n">minimize_opts</span> <span class="o">=</span> <span class="p">{},</span>
                                      <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">Rf</span><span class="p">,</span> <span class="n">Rg</span> <span class="o">=</span> <span class="n">spd_to_cris</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obj_fcn1:&#39;</span><span class="p">,</span><span class="n">Rf</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obj_fcn2:&#39;</span><span class="p">,</span><span class="n">Rg</span><span class="p">)</span>


    <span class="c1">#-------------------------------------------------------------------------- </span>
    <span class="k">if</span> <span class="n">run_example_fcn_2</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                
        <span class="k">def</span> <span class="nf">user_prim_constructor2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nprims</span><span class="p">,</span> <span class="n">wlr</span><span class="p">,</span> 
                                   <span class="n">ptypes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;peakwl&#39;</span><span class="p">,</span><span class="s1">&#39;spectral_width&#39;</span><span class="p">],</span> 
                                   <span class="o">**</span><span class="n">pdefs</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            User defined prim constructor: lorenztian 2e order profile.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Extract the primary parameters from x and prim_constructor_parameter_defs:</span>
            <span class="n">pars</span> <span class="o">=</span> <span class="n">_extract_prim_optimization_parameters</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nprims</span><span class="p">,</span> <span class="n">ptypes</span><span class="p">,</span> <span class="n">pdefs</span><span class="p">)</span>
            
            <span class="c1"># setup wavelengths:</span>
            <span class="n">wlr</span> <span class="o">=</span> <span class="n">_setup_wlr</span><span class="p">(</span><span class="n">wlr</span><span class="p">)</span>
            
            <span class="c1"># Collect parameters from pars dict:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mf">0.5</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="c1"># to ensure correct fwhm</span>
            <span class="n">spd</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;peakwl&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">wlr</span><span class="p">)</span><span class="o">/</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;spectral_width&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">_stack_wlr_spd</span><span class="p">(</span><span class="n">wlr</span><span class="p">,</span> <span class="n">spd</span><span class="p">)</span>
        
        
        <span class="c1"># Create a minimization function with the specified interface:</span>
        <span class="k">def</span> <span class="nf">user_minim2</span><span class="p">(</span><span class="n">fitnessfcn</span><span class="p">,</span> <span class="n">Nparameters</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">minimize_opts</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">particleswarm</span><span class="p">(</span><span class="n">fitnessfcn</span><span class="p">,</span> <span class="n">Nparameters</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">,</span> 
                                         <span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">,</span> 
                                         <span class="n">iters</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">n_particles</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">ftol</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>
                                         <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;c1&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span><span class="mf">0.9</span><span class="p">},</span>
                                         <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>
            <span class="c1"># Note that there is already a key &#39;x_final&#39; in results</span>
            <span class="k">return</span> <span class="n">results</span>
        
        
        <span class="c1"># start optimization:</span>
        <span class="n">spd</span><span class="p">,</span> <span class="n">prims</span><span class="p">,</span> <span class="n">M</span> <span class="o">=</span> <span class="n">spd_optimizer2</span><span class="p">(</span><span class="n">np2d</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">]),</span> <span class="n">tar_type</span> <span class="o">=</span> <span class="s1">&#39;Yxy&#39;</span><span class="p">,</span> <span class="n">cspace_bwtf</span> <span class="o">=</span> <span class="p">{},</span>
                                      <span class="n">n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wlr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">360</span><span class="p">,</span><span class="mi">830</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">prims</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                      <span class="n">cieobs</span> <span class="o">=</span> <span class="n">cieobs</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;spds,primss,Ms&#39;</span><span class="p">,</span> 
                                      <span class="n">prim_constructor</span> <span class="o">=</span> <span class="n">user_prim_constructor2</span><span class="p">,</span>
                                      <span class="n">prim_constructor_parameter_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;peakwl&#39;</span><span class="p">,</span> <span class="s1">&#39;spectral_width&#39;</span><span class="p">],</span> 
                                      <span class="n">prim_constructor_parameter_defs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;peakwl_bnds&#39;</span><span class="p">:[</span><span class="mi">400</span><span class="p">,</span><span class="mi">700</span><span class="p">],</span>
                                                                         <span class="s1">&#39;spectral_width_bnds&#39;</span><span class="p">:[</span><span class="mi">5</span><span class="p">,</span><span class="mi">300</span><span class="p">]},</span>
                                      <span class="n">obj_fcn</span> <span class="o">=</span> <span class="p">[(</span><span class="n">spd_to_cris</span><span class="p">,</span><span class="s1">&#39;Rf&#39;</span><span class="p">,</span><span class="s1">&#39;Rg&#39;</span><span class="p">)],</span> 
                                      <span class="n">obj_fcn_pars</span> <span class="o">=</span> <span class="p">[{}],</span> 
                                      <span class="n">obj_fcn_weights</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)],</span> <span class="n">obj_tar_vals</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">90</span><span class="p">,</span><span class="mi">110</span><span class="p">)],</span>
                                      <span class="n">triangle_strengths_bnds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                      <span class="n">minimize_method</span> <span class="o">=</span> <span class="n">user_minim2</span><span class="p">,</span>
                                      <span class="n">minimize_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pareto&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">},</span>
                                      <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="n">Rf</span><span class="p">,</span> <span class="n">Rg</span> <span class="o">=</span> <span class="n">spd_to_cris</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obj_fcn1:&#39;</span><span class="p">,</span><span class="n">Rf</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;obj_fcn2:&#39;</span><span class="p">,</span><span class="n">Rg</span><span class="p">)</span>
  

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Kevin A.G. Smet.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>